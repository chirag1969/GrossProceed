
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>REGULAR SEP-25 Performance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <style>
    :root {
      color-scheme: light;
      --bg: #f4f6fb;
      --card-bg: #fff;
      --text: #1b1e28;
      --muted: #5f677b;
      --accent: #145afc;
      --sticky-header-offset: 72px;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .tab-nav {
      display: flex;
      gap: 1rem;
      margin: 1rem 2rem 0.75rem;
      border-bottom: 1px solid rgba(27, 30, 40, 0.1);
    }
    .tab-button {
      position: relative;
      padding: 0.65rem 1.5rem;
      border: none;
      background: none;
      font: inherit;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: color 0.2s ease, border-color 0.2s ease;
    }
    .tab-button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
    }
    .tab-button.active {
      color: var(--text);
      border-color: var(--accent);
    }
    .tab-panel {
      display: none;
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;
    }
    .tab-panel.active {
      display: flex;
      flex-direction: column;
    }
    .grid {
      display: grid;
      gap: 1rem;
      padding: 0 2rem 1.5rem;
      flex: 1 1 auto;
      min-height: 0;
      grid-auto-rows: minmax(0, 1fr);
    }
    .grid > * {
      min-width: 0;
    }
    .lo-grid {
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    .lo-card {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow: hidden;
      flex: 1 1 auto;
      min-height: 0;
    }
    .lo-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .lo-card__heading {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-width: 0;
    }
    .lo-card__title {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
    }
    .lo-card__subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .sub-tab-nav {
      display: inline-flex;
      gap: 0.75rem;
      background: rgba(20, 90, 252, 0.08);
      padding: 0.4rem;
      border-radius: 999px;
      width: fit-content;
    }
    .sub-tab-button {
      border: none;
      background: transparent;
      font: inherit;
      font-weight: 600;
      color: var(--muted);
      padding: 0.45rem 1.25rem;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .sub-tab-button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .sub-tab-button.active {
      background: var(--card-bg);
      color: var(--text);
      box-shadow: 0 6px 16px rgba(20, 90, 252, 0.15);
    }
    .sub-tab-panel {
      display: none;
      flex: 1 1 auto;
      min-height: 0;
    }
    .sub-tab-panel.active {
      display: flex;
      flex-direction: column;
    }
    .lo-card {
      min-height: calc(100vh - var(--sticky-header-offset) - 2.75rem);
    }

    .lo-table-container {
      position: relative;
      border-radius: 0.75rem;
      border: 1px solid rgba(27, 30, 40, 0.08);
      box-shadow: inset 0 0 0 1px rgba(27, 30, 40, 0.03), 0 12px 30px rgba(15, 23, 42, 0.08);
      background: #fff;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      flex: 1 1 auto;
      min-height: 0;
      padding-bottom: 0;
      display: flex;
      overflow: hidden;
    }

    .lo-table-scroll {
      flex: 1 1 auto;
      min-height: 0;
      width: 100%;
      height: 100%;
      overflow-x: auto;
      overflow-y: auto;
      border-radius: inherit;
      scroll-padding-bottom: 96px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .lo-table {
      width: 100%;
      min-width: 720px;
      min-width: max(720px, 100%);
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .lo-table thead th {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: linear-gradient(180deg, #f6f8ff 0%, #e3e8f7 100%);
      color: var(--muted);
      font-weight: 600;
      padding: 0.65rem 0.75rem;
      text-align: right;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .lo-table thead th:first-child {
      text-align: left;
      z-index: 7;
    }
    .lo-table tbody td {
      padding: 0.35rem 0.75rem;
      border-top: 1px solid rgba(27, 30, 40, 0.08);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .lo-table tbody td.cell-date {
      text-align: left;
      font-weight: 600;
      color: var(--text);
    }
    .lo-table thead th:first-child,
    .lo-table tbody td.cell-date,
    .lo-table tfoot th:first-child {
      position: sticky;
      left: 0;
      z-index: 4;
    }
    .lo-table thead th:first-child {
      z-index: 6;
      box-shadow: 8px 0 12px rgba(15, 23, 42, 0.08);
    }
    .lo-table tbody td.cell-date {
      background: inherit;
      box-shadow: 8px 0 12px rgba(15, 23, 42, 0.06);
    }
    .lo-table tbody tr:nth-child(odd) td.cell-date {
      background: rgba(226, 231, 244, 0.25);
    }
    .lo-table tbody tr:hover td.cell-date {
      background: rgba(41, 71, 137, 0.12);
    }
    .lo-table tfoot th:first-child {
      z-index: 5;
      box-shadow: 8px 0 12px rgba(15, 23, 42, 0.08);
    }
    .lo-table tbody tr:nth-child(odd) td {
      background: rgba(226, 231, 244, 0.25);
    }
    .lo-table tfoot {
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, #f6f8ff 0%, #e3e8f7 100%);
      box-shadow: 0 -8px 16px rgba(15, 23, 42, 0.08);
      z-index: 2;
    }
    .lo-table tfoot th,
    .lo-table tfoot td {
      position: sticky;
      bottom: 0;
      background: inherit;
      color: var(--text);
      font-weight: 600;
      padding: 0.55rem 0.75rem;
      border-top: 1px solid rgba(27, 30, 40, 0.14);
      z-index: 3;
    }
    .lo-table tfoot th {
      text-align: left;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.78rem;
    }
    .lo-table tfoot td {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .lo-table tfoot::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: -16px;
      height: 16px;
      pointer-events: none;
      background: linear-gradient(180deg, rgba(244, 246, 251, 0) 0%, rgba(244, 246, 251, 0.9) 100%);
    }
    .card {
      background: var(--card-bg);
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: 0 8px 24px rgba(16, 24, 40, 0.06);
    }
    .table-card {
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }
    .regular-card {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1 1 auto;
      min-height: calc(100vh - var(--sticky-header-offset) - 2.75rem);
    }
    .regular-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      padding: 0;
      flex-wrap: wrap;
    }
    .regular-card__heading {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-width: 0;
    }
    .regular-card__controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-left: auto;
    }
    .filter-button {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      border: 1px solid rgba(20, 90, 252, 0.35);
      background: rgba(20, 90, 252, 0.12);
      color: var(--accent);
      font-weight: 600;
      font-size: 0.9rem;
      padding: 0.55rem 1.1rem;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .lo-card__filter-button--hidden {
      display: none !important;
    }
    .filter-button:hover,
    .filter-button:focus-visible {
      border-color: var(--accent);
      background: rgba(20, 90, 252, 0.2);
      outline: none;
      box-shadow: 0 10px 22px rgba(20, 90, 252, 0.18);
    }
    .filter-button[data-active="true"] {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 12px 26px rgba(20, 90, 252, 0.28);
    }
    .filter-button[aria-disabled="true"] {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    .regular-card__title {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
    }
    .regular-card__subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .regular-card__pagination {
      margin-left: auto;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
      flex-wrap: wrap;
      min-height: 2.5rem;
    }
    .regular-card__pagination:empty {
      display: none;
    }
    .regular-card__pagination .dataTables_paginate {
      float: none;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .regular-card__pagination .paginate_button {
      border-radius: 999px !important;
      padding: 0.35rem 0.85rem;
      border: 1px solid rgba(20, 90, 252, 0.25) !important;
      color: var(--accent) !important;
      background: #fff !important;
      font-weight: 600;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .regular-card__pagination .paginate_button.current,
    .regular-card__pagination .paginate_button:hover,
    .regular-card__pagination .paginate_button:focus {
      background: rgba(20, 90, 252, 0.12) !important;
      border-color: rgba(20, 90, 252, 0.45) !important;
      outline: none;
    }
    .regular-card__pagination .paginate_button:focus-visible {
      box-shadow: 0 0 0 2px rgba(20, 90, 252, 0.35);
    }
    .regular-card__pagination .paginate_button.disabled,
    .regular-card__pagination .paginate_button.disabled:hover {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .regular-table-container {
      border-radius: 0.85rem;
      border: 1px solid rgba(64, 80, 120, 0.18);
      box-shadow: 0 12px 30px rgba(21, 32, 56, 0.12);
      background: #fff;
      flex: 1 1 auto;
      min-height: 0;
      overflow: visible;
      display: flex;
      flex-direction: column;
      padding-bottom: 1rem;
    }
    .regular-table-container .dataTables_wrapper {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    .regular-table-container .dataTables_scroll {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    .regular-table-container .dataTables_scrollHead {
      flex: 0 0 auto;
    }
    .regular-table-container .dataTables_scrollBody {
      flex: 1 1 auto !important;
    }
    .regular-table-container .dataTables_scrollFoot {
      flex: 0 0 auto;
    }
    .regular-table-container table {
      margin-top: 0;
    }
    #tab-sku-summary .grid {
      grid-auto-rows: auto;
      align-content: flex-start;
    }
    .sku-card {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      flex: 1 1 auto;
      min-height: 0;
      max-height: clamp(24rem, calc(100vh - var(--sticky-header-offset) - 3.25rem), 60rem);
    }
    .sku-card__header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      flex: 0 0 auto;
    }
    .sku-card__title {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
    }
    .sku-card__subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .sku-card__toolbar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.1rem;
    }
    .sku-card__toolbar[data-active='false'] .sku-card__pagination {
      display: none;
    }
    .sku-card__pagination {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      margin-left: auto;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .sku-card__pagination[aria-hidden='true'] {
      display: none;
    }
    .sku-card__pagination-info {
      white-space: nowrap;
    }
    .sku-card__pagination-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(27, 30, 40, 0.12);
      background: #fff;
      color: var(--text);
      font: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }
    .sku-card__pagination-button:hover,
    .sku-card__pagination-button:focus {
      background: rgba(20, 90, 252, 0.12);
      border-color: rgba(20, 90, 252, 0.45);
      color: var(--accent);
    }
    .sku-card__pagination-button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .sku-card__pagination-button[disabled] {
      opacity: 0.45;
      cursor: default;
      background: rgba(27, 30, 40, 0.06);
      border-color: rgba(27, 30, 40, 0.08);
      color: var(--muted);
    }
    .sku-card__pagination-button[disabled]:hover,
    .sku-card__pagination-button[disabled]:focus {
      background: rgba(27, 30, 40, 0.06);
      border-color: rgba(27, 30, 40, 0.08);
      color: var(--muted);
    }
    .sku-table-container {
      border-radius: 0.85rem;
      border: 1px solid rgba(64, 80, 120, 0.18);
      box-shadow: 0 12px 30px rgba(21, 32, 56, 0.12);
      background: #fff;
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .sku-table-scroll {
      flex: 1 1 auto;
      min-height: 0;
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (max-width: 768px) {
      .sku-card {
        max-height: none;
      }
    }
    .sku-table {
      width: 100%;
      min-width: 720px;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .sku-table thead th {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, #f6f8ff 0%, #e3e8f7 100%);
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0.65rem 0.75rem;
      text-align: right;
      z-index: 3;
    }
    .sku-table thead th:first-child {
      text-align: left;
      box-shadow: 8px 0 12px rgba(15, 23, 42, 0.08);
      z-index: 4;
    }
    .sku-table tbody td,
    .sku-table tfoot td {
      padding: 0.45rem 0.75rem;
      border-top: 1px solid rgba(27, 30, 40, 0.08);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .sku-table tbody td:first-child {
      position: sticky;
      left: 0;
      text-align: left;
      font-weight: 600;
      color: var(--text);
      background: inherit;
      box-shadow: 8px 0 12px rgba(15, 23, 42, 0.06);
      z-index: 2;
    }
    .sku-table thead th:first-child,
    .sku-table tbody td:first-child,
    .sku-table tfoot th:first-child {
      background-clip: padding-box;
    }
    .sku-table tbody tr:nth-child(odd) td {
      background: rgba(226, 231, 244, 0.25);
    }
    .sku-table tbody tr:hover td {
      background: rgba(41, 71, 137, 0.12);
    }
    .sku-table tfoot {
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, #f6f8ff 0%, #e3e8f7 100%);
      box-shadow: 0 -8px 16px rgba(15, 23, 42, 0.08);
      z-index: 1;
    }
    .sku-table tfoot th,
    .sku-table tfoot td {
      padding: 0.55rem 0.75rem;
      border-top: 1px solid rgba(27, 30, 40, 0.14);
      font-weight: 600;
    }
    .sku-table tfoot th {
      position: sticky;
      left: 0;
      text-align: left;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.78rem;
      color: var(--muted);
      box-shadow: 8px 0 12px rgba(15, 23, 42, 0.08);
      z-index: 2;
    }
    .sku-table th,
    .sku-table td {
      border-right: none;
      border-left: none;
    }
    .sku-table__message {
      text-align: left;
      padding: 1rem 0.75rem;
      font-weight: 600;
      color: var(--muted);
    }
    .kpi-title {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .kpi-value {
      font-size: 1.75rem;
      font-weight: 600;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      text-align: left;
      padding: 0.5rem 0.75rem;
      border-right: 1px solid rgba(27, 30, 40, 0.12);
    }
    th:first-child,
    td:first-child {
      border-left: 1px solid rgba(27, 30, 40, 0.12);
    }
    th:last-child,
    td:last-child {
      border-right: 1px solid rgba(27, 30, 40, 0.12);
    }
    th {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .table-container {
      position: relative;
      overflow: visible;
      padding: 0;
      flex: 1 1 auto;
      min-height: 0;
      max-width: 100%;
      display: flex;
      flex-direction: column;
    }
    #tab-regular .table-card {
      background: transparent;
      box-shadow: none;
      padding: 0;
    }
    #tab-regular .table-container {
      padding-right: 0;
      padding-bottom: 0;
    }
    #regular-table {
      border-collapse: separate;
      width: 100%;
    }
    #regular-table thead th,
    #regular-table tbody td {
      text-align: left;
      padding: 0.3rem 0.65rem;
      border-right: 1px solid rgba(15, 23, 42, 0.08);
      line-height: 1.15;
      box-sizing: border-box;
    }
    #regular-table thead th {
      white-space: normal;
    }
    #regular-table tbody td {
      white-space: nowrap;
    }
    #regular-table thead th:first-child,
    #regular-table tbody td:first-child {
      border-left: 1px solid rgba(15, 23, 42, 0.08);
    }
    #regular-table thead th:last-child,
    #regular-table tbody td:last-child {
      border-right: 1px solid rgba(15, 23, 42, 0.08);
    }
    #regular-table thead th {
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #000;
      font-weight: 700;
      background: linear-gradient(180deg, #f6f8ff 0%, #e3e8f7 100%);
      border-bottom: 2px solid rgba(70, 97, 145, 0.35);
    }
    #regular-table tbody td {
      font-size: 0.82rem;
      color: rgba(27, 30, 40, 0.9);
      font-weight: 500;
      background: #fff;
    }
    #regular-table tbody tr {
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
    }
    #regular-table tbody tr:nth-child(even) td {
      background: rgba(226, 231, 244, 0.35);
    }
    #regular-table tbody tr:hover td {
      background: rgba(41, 71, 137, 0.12);
    }
    #regular-table thead th.cell-numeric,
    #regular-table tbody td.cell-numeric {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    #regular-table tbody td.cell-qty {
      font-weight: 600;
    }
    #regular-table thead th.is-filterable {
      cursor: pointer;
      position: relative;
    }
    #regular-table thead th.has-filter::after {
      content: '';
      position: absolute;
      top: 0.6rem;
      right: 0.5rem;
      width: 0.35rem;
      height: 0.35rem;
      border-radius: 50%;
      background: var(--accent);
    }
    #regular-table td.cell-multiline {
      white-space: normal !important;
      word-break: break-word;
      line-height: 1.35;
    }
    #regular-table th.cell-product,
    #regular-table td.cell-product {
      min-width: 24ch;
      max-width: 32ch;
      white-space: nowrap !important;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #regular-table_wrapper {
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }
    #regular-table_wrapper .dataTables_scroll {
      border: none;
      border-radius: inherit;
      background: transparent;
      box-shadow: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }
    #regular-table_wrapper .dataTables_scrollHead {
      position: relative;
      top: auto;
      z-index: 5;
      background: transparent;
      overflow: hidden;
      box-shadow: 0 8px 18px rgba(21, 32, 56, 0.12);
      flex: 0 0 auto;
    }
    #regular-table_wrapper .dataTables_scrollHead table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100% !important;
    }
    #regular-table_wrapper .dataTables_scrollBody {
      border-top: none;
      overflow-y: auto !important;
      overflow-x: auto !important;
      flex: 1 1 auto;
      min-height: 0;
    }
    #regular-table_wrapper .dataTables_scrollBody table {
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      width: 100% !important;
    }
    #regular-table_wrapper .dataTables_scrollFoot {
      position: sticky;
      bottom: 0;
      z-index: 12;
      background: linear-gradient(180deg, #f5f7ff 0%, #ebeffd 100%);
      box-shadow: 0 -10px 24px rgba(21, 32, 56, 0.1);
      flex: 0 0 auto;
    }
    #regular-table_wrapper .dataTables_scrollFoot th {
      position: sticky;
      bottom: 0;
      z-index: 13;
      padding: 0.6rem 0.7rem;
      font-size: 0.82rem;
      font-weight: 700;
      color: #1b1e28;
      text-transform: uppercase;
      background: transparent;
      border-top: 2px solid rgba(15, 23, 42, 0.08);
    }
    #regular-table_wrapper .dataTables_scrollFoot th.cell-total-label {
      text-align: left;
      color: #2d3748;
    }
    #regular-table_wrapper .dataTables_scrollFoot th.cell-total {
      text-align: right;
    }
    #regular-table_wrapper .dataTables_scrollFoot th.cell-total-column {
      background: linear-gradient(180deg, #fff4d7 0%, #ffd897 100%);
      border-left: 2px solid rgba(15, 23, 42, 0.08);
      z-index: 14;
    }
    #regular-table_wrapper .dataTables_scrollHead th.cell-total-column,
    #regular-table_wrapper .dataTables_scrollBody td.cell-total-column,
    #regular-table_wrapper .dataTables_scrollFoot th.cell-total-column {
      position: sticky;
      right: 0;
      z-index: 4;
    }
    #regular-table_wrapper .dataTables_scrollHead th.cell-total-column {
      z-index: 7;
      background: linear-gradient(180deg, #fef5e6 0%, #fbdca3 100%);
      color: #5c3c00;
      border-left: 2px solid rgba(15, 23, 42, 0.08);
    }
    #regular-table_wrapper .dataTables_scrollBody td.cell-total-column {
      background: linear-gradient(180deg, #fffdf7 0%, #fff0d3 100%);
      font-weight: 600;
      border-left: 2px solid rgba(15, 23, 42, 0.08);
    }
    #regular-table_wrapper .dataTables_scrollBody tr:nth-child(even) td.cell-total-column {
      background: linear-gradient(180deg, #fff9ec 0%, #ffe7bf 100%);
    }
    #regular-table_wrapper .dataTables_scrollBody tr:hover td.cell-total-column {
      background: rgba(41, 71, 137, 0.18);
    }
    .regular-table__footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      padding: 0.75rem 0.5rem 0;
      color: var(--muted);
      font-size: 0.85rem;
      flex-wrap: wrap;
    }
    .regular-table__footer:empty {
      display: none;
    }
    .regular-table__footer .dataTables_paginate {
      margin: 0 !important;
    }
    #regular-table_wrapper .dataTables_paginate .paginate_button {
      border-radius: 999px;
    }
    table.dataTable thead .sorting,
    table.dataTable thead .sorting_asc,
    table.dataTable thead .sorting_desc,
    table.dataTable thead .sorting_asc_disabled,
    table.dataTable thead .sorting_desc_disabled {
      background-image: none !important;
    }
    table.dataTable thead > tr > th.sorting::before,
    table.dataTable thead > tr > th.sorting::after,
    table.dataTable thead > tr > th.sorting_asc::before,
    table.dataTable thead > tr > th.sorting_asc::after,
    table.dataTable thead > tr > th.sorting_desc::before,
    table.dataTable thead > tr > th.sorting_desc::after,
    table.dataTable thead > tr > th.sorting_asc_disabled::before,
    table.dataTable thead > tr > th.sorting_asc_disabled::after,
    table.dataTable thead > tr > th.sorting_desc_disabled::before,
    table.dataTable thead > tr > th.sorting_desc_disabled::after {
      display: none !important;
    }
    .header-menu {
      position: absolute;
      z-index: 20;
      min-width: 240px;
      max-width: 280px;
      background: var(--card-bg);
      border-radius: 0.75rem;
      box-shadow: 0 20px 35px rgba(15, 23, 42, 0.15);
      border: 1px solid rgba(27, 30, 40, 0.08);
      padding: 1rem;
      color: var(--text);
    }
    .header-menu.hidden {
      display: none;
    }
    .header-menu__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .header-menu__title {
      font-size: 0.95rem;
      margin: 0;
    }
    .header-menu__close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .header-menu__section {
      margin-bottom: 1rem;
    }
    .header-menu__buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .header-menu__button {
      flex: 1 1 auto;
      border: 1px solid rgba(27, 30, 40, 0.12);
      background: #f8f9fe;
      color: var(--text);
      border-radius: 999px;
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .header-menu__button:hover,
    .header-menu__button:focus-visible {
      border-color: var(--accent);
      background: rgba(20, 90, 252, 0.12);
      outline: none;
    }
    .header-menu__search {
      width: 100%;
      border-radius: 0.5rem;
      border: 1px solid rgba(27, 30, 40, 0.12);
      padding: 0.45rem 0.6rem;
      font: inherit;
    }
    .header-menu__options {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(27, 30, 40, 0.1);
      border-radius: 0.65rem;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .header-menu__options:empty {
      display: none;
      border: none;
      padding: 0;
    }
    .header-menu__empty-message {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .header-menu__option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text);
    }
    .header-menu__option input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent);
    }
    .header-menu__footer {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .header-menu__apply,
    .header-menu__clear {
      flex: 1;
      border-radius: 999px;
      padding: 0.45rem 0.75rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .header-menu__apply {
      background: var(--accent);
      color: #fff;
    }
    .header-menu__apply:hover,
    .header-menu__apply:focus-visible {
      background: #0f46c2;
      outline: none;
    }
    .header-menu__clear {
      background: rgba(20, 90, 252, 0.12);
      color: var(--accent);
      border-color: rgba(20, 90, 252, 0.3);
    }
    .header-menu__clear:hover,
    .header-menu__clear:focus-visible {
      background: rgba(20, 90, 252, 0.2);
      outline: none;
    }
    .regular-filter {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    .regular-filter.is-visible {
      display: flex;
    }
    .regular-filter__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(2px);
    }
    .regular-filter__dialog {
      position: relative;
      z-index: 1;
      width: min(92vw, 420px);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: var(--card-bg);
      border-radius: 0.85rem;
      box-shadow: 0 28px 55px rgba(15, 23, 42, 0.22);
      padding: 1.35rem;
    }
    .regular-filter__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    .regular-filter__title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
    }
    .regular-filter__close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
      padding: 0;
    }
    .regular-filter__field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .regular-filter__label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .regular-filter__select,
    .regular-filter__search {
      border-radius: 0.65rem;
      border: 1px solid rgba(27, 30, 40, 0.15);
      padding: 0.55rem 0.7rem;
      font: inherit;
      background: #fff;
      color: var(--text);
    }
    .regular-filter__select:disabled,
    .regular-filter__search:disabled {
      background: rgba(244, 246, 251, 0.65);
      cursor: not-allowed;
    }
    .regular-filter__select-all {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
    }
    .regular-filter__select-all input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent);
    }
    .regular-filter__options {
      flex: 1 1 auto;
      overflow-y: auto;
      border: 1px solid rgba(27, 30, 40, 0.12);
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      min-height: 180px;
      background: rgba(244, 246, 251, 0.55);
    }
    .regular-filter__options:empty {
      padding: 0;
      border: none;
      min-height: 0;
    }
    .regular-filter__option {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.88rem;
      color: var(--text);
      line-height: 1.3;
    }
    .regular-filter__option input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent);
    }
    .regular-filter__empty {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .regular-filter__footer {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .regular-filter__apply,
    .regular-filter__reset {
      flex: 1 1 auto;
      border-radius: 999px;
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .regular-filter__apply {
      background: var(--accent);
      color: #fff;
    }
    .regular-filter__apply:hover,
    .regular-filter__apply:focus-visible {
      background: #0f46c2;
      outline: none;
      box-shadow: 0 12px 24px rgba(20, 90, 252, 0.32);
    }
    .regular-filter__reset {
      background: rgba(20, 90, 252, 0.14);
      color: var(--accent);
      border-color: rgba(20, 90, 252, 0.32);
    }
    .regular-filter__reset:hover,
    .regular-filter__reset:focus-visible {
      background: rgba(20, 90, 252, 0.22);
      outline: none;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    @media (max-width: 768px) {
      .regular-card__header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
      .regular-card__controls {
        width: 100%;
        justify-content: flex-start;
        margin-left: 0;
      }
      .regular-card__pagination {
        width: 100%;
        justify-content: flex-start;
        margin-left: 0;
      }
    }
    @media (max-width: 1280px) {
      .lo-grid {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 900px) {
      .tab-nav {
        margin: 1rem 1rem 0.75rem;
      }
      .grid {
        padding: 0 1rem 1.5rem;
      }
      #regular-table_wrapper .dataTables_scrollHead {
        top: calc(var(--sticky-header-offset) - 24px);
      }
    }
  </style>
</head>
<body>
  <nav class="tab-nav" aria-label="Dashboard views">
    <button class="tab-button active" id="tab-lo-button" type="button" data-tab="lo" aria-controls="tab-lo" aria-selected="true">LO - Sales &amp; Spend</button>
    <button class="tab-button" id="tab-sku-summary-button" type="button" data-tab="sku-summary" aria-controls="tab-sku-summary" aria-selected="false">SKU wise summary</button>
    <button class="tab-button" id="tab-regular-button" type="button" data-tab="regular" aria-controls="tab-regular" aria-selected="false">Regular</button>
  </nav>
  <div class="tab-panel active" id="tab-lo" data-tab="lo" role="tabpanel" aria-labelledby="tab-lo-button" aria-hidden="false">
    <section class="grid lo-grid">
      <article class="card lo-card">
        <header class="lo-card__header">
          <div class="lo-card__heading">
            <h2 class="lo-card__title">Listing owner performance</h2>
            <p class="lo-card__subtitle">Daily sales and spend totals derived from regular data</p>
          </div>
          <button type="button" class="filter-button lo-card__filter-button" id="lo-filter-button" aria-haspopup="dialog" aria-expanded="false">Filters</button>
        </header>
        <nav class="sub-tab-nav" aria-label="Listing owner metrics">
          <button class="sub-tab-button active" id="lo-sales-button" type="button" data-subtab="sales" aria-controls="lo-sales-panel" aria-selected="true">Sales</button>
          <button class="sub-tab-button" id="lo-spend-button" type="button" data-subtab="spend" aria-controls="lo-spend-panel" aria-selected="false">Spend</button>
        </nav>
        <div class="sub-tab-panel active" id="lo-sales-panel" data-subtab="sales" role="region" aria-labelledby="lo-sales-button">
          <div class="table-container lo-table-container">
            <div class="lo-table-scroll">
              <table id="lo-sales-table" class="lo-table"></table>
            </div>
          </div>
        </div>
        <div class="sub-tab-panel" id="lo-spend-panel" data-subtab="spend" role="region" aria-labelledby="lo-spend-button" aria-hidden="true">
          <div class="table-container lo-table-container">
            <div class="lo-table-scroll">
              <table id="lo-spend-table" class="lo-table"></table>
            </div>
          </div>
        </div>
      </article>
    </section>
  </div>
  <div class="tab-panel" id="tab-sku-summary" data-tab="sku-summary" role="tabpanel" aria-labelledby="tab-sku-summary-button" aria-hidden="true">
    <section class="grid">
      <article class="card sku-card">
        <header class="sku-card__header">
          <h2 class="sku-card__title">SKU wise summary</h2>
          <p class="sku-card__subtitle">Pivoted averages, fees, and totals by SKU directly from the workbook</p>
          <div class="sku-card__toolbar" data-active="false">
            <button type="button" class="filter-button sku-card__filter-button" id="sku-filter-button" aria-haspopup="dialog" aria-expanded="false">Filters</button>
            <div class="sku-card__pagination" id="sku-summary-pagination" aria-label="SKU wise summary pagination" aria-hidden="true"></div>
          </div>
        </header>
        <div class="table-container sku-table-container">
          <div class="sku-table-scroll">
            <table id="sku-summary-table" class="sku-table"></table>
          </div>
        </div>
      </article>
    </section>
  </div>
  <div class="tab-panel" id="tab-regular" data-tab="regular" role="tabpanel" aria-labelledby="tab-regular-button" aria-hidden="true">
    <section class="grid">
      <article class="card regular-card">
        <header class="regular-card__header">
          <div class="regular-card__heading">
            <h2 class="regular-card__title">Regular Performance</h2>
            <p class="regular-card__subtitle">Detailed order and spend metrics across all listings</p>
          </div>
          <div class="regular-card__controls">
            <button type="button" class="regular-card__filter-button filter-button" id="regular-filter-button" aria-haspopup="dialog" aria-expanded="false" data-active="false">Filters</button>
            <div class="regular-card__pagination" id="regular-table-pagination" aria-label="Regular table pagination"></div>
          </div>
        </header>
        <div class="table-container regular-table-container">
          <table id="regular-table" class="display" style="width:100%"></table>
        </div>
      </article>
    </section>
  </div>
  <div class="regular-filter" id="regular-filter" hidden aria-hidden="true">
    <div class="regular-filter__backdrop"></div>
    <div class="regular-filter__dialog" role="dialog" aria-modal="true" aria-labelledby="regular-filter-title">
      <div class="regular-filter__header">
        <h3 class="regular-filter__title" id="regular-filter-title">Filter regular data</h3>
        <button type="button" class="regular-filter__close" aria-label="Close filters">&times;</button>
      </div>
      <div class="regular-filter__field">
        <label class="regular-filter__label" for="regular-filter-column">Column</label>
        <select id="regular-filter-column" class="regular-filter__select"></select>
      </div>
      <div class="regular-filter__field">
        <label class="regular-filter__label" for="regular-filter-search">Search</label>
        <input id="regular-filter-search" class="regular-filter__search" type="search" placeholder="Search values" autocomplete="off" />
      </div>
      <label class="regular-filter__select-all" for="regular-filter-select-all">
        <input type="checkbox" id="regular-filter-select-all" />
        <span>Select all</span>
      </label>
      <div class="regular-filter__options" id="regular-filter-options" role="group" aria-label="Filter values"></div>
      <p class="regular-filter__empty" id="regular-filter-empty" hidden>No matches found</p>
      <div class="regular-filter__footer">
        <button type="button" class="regular-filter__reset" id="regular-filter-reset">Reset</button>
        <button type="button" class="regular-filter__apply" id="regular-filter-apply">Apply</button>
      </div>
    </div>
  </div>
  <script>
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const subTabButtons = document.querySelectorAll('.sub-tab-button');
    const subTabPanels = document.querySelectorAll('.sub-tab-panel');
    const loFilterButtonElement = document.getElementById('lo-filter-button');

    let regularTable;
    let regularTableInitialised = false;
    let regularTableFooterValues = [];
    let regularTableNumericColumnSet = new Set();
    let regularTableAugmentedDataset = null;
    let datasetCache = null;
    let datasetPromise = null;
    let loTablesInitialised = false;
    let spendPivotCache = null;
    let spendPivotPromise = null;
    let skuSummaryInitialised = false;
    let skuSummaryPivotCache = null;
    let skuSummaryPivotPromise = null;
    let skuSummaryCurrentPage = 1;
    let skuSummaryPageSize = 25;
    let skuSummaryTotalRows = 0;

    const NUMERIC_COLUMN_EXCLUSIONS = new Set(['ORDER NO', 'PLAIN ORDER NO', 'ORDER #', 'ORDER NO.', 'CHECKOUT']);
    const ZERO_DECIMAL_COLUMNS = new Set(['qty', 'order no', 'plain order no', 'order no.', 'order #']);
    const numberFormatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const integerFormatter = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const displayDateFormatter = new Intl.DateTimeFormat('en-US', { month: '2-digit', day: '2-digit' });
    const TOTAL_ROW_LABEL = 'Grand Total';

    let columnValueOptions = [];
    let columnFilters = {};
    let regularFilterButtonElement = null;
    let regularFilterContainerElement = null;
    let regularFilterColumnSelect = null;
    let regularFilterSearchInput = null;
    let regularFilterOptionsElement = null;
    let regularFilterEmptyElement = null;
    let regularFilterSelectAllInput = null;
    let regularFilterApplyButton = null;
    let regularFilterResetButton = null;
    let regularFilterCloseButton = null;
    let regularFilterActiveColumnIndex = null;
    let regularFilterSelection = new Set();
    let regularFilterSearchTerm = '';
    let regularFilterInitialised = false;
    let regularFilterEligibleColumns = [];
    let regularFilterButtons = [];
    let activeRegularFilterTrigger = null;
    let totalColumnIndex = -1;
    let headerMenuElement;
    let activeHeaderCell = null;
    let activeColumnIndex = null;
    const headerClickHandlers = new WeakMap();
    const HEADER_HEIGHT = 44;
    const ROW_HEIGHT = 34;
    const MIN_VISIBLE_ROWS = 5;
    const TABLE_BOTTOM_MARGIN = 18;
    const LO_TABLE_BOTTOM_MARGIN = 24;
    const MIN_LO_TABLE_HEIGHT = 320;
    const REGULAR_TABLE_FOOTER_MIN_SPACE = 128;
    const REGULAR_TABLE_FOOTER_EXTRA_GAP = 24;
    const DEFAULT_REGULAR_TABLE_RESERVED_SPACE = TABLE_BOTTOM_MARGIN + REGULAR_TABLE_FOOTER_MIN_SPACE;
    const REGULAR_TABLE_PAGE_LENGTH = 200;
    const SHOW_REGULAR_TOTAL_ROW = true;
    const REGULAR_FILTER_MAX_UNIQUE_VALUES = 350;

    let loSalesOrderCache = [];
    let loDisplayNameOverridesCache = new Map();
    let loBaselineSpendPivot = null;
    let loSpendScalingData = null;
    let loBaselineAdSpendPivot = null;

    function fetchDataset() {
      if (datasetCache) {
        return Promise.resolve(datasetCache);
      }
      if (datasetPromise) {
        return datasetPromise;
      }
      datasetPromise = fetch('regular_sep25_data.json')
        .then((response) => {
          if (!response.ok) {
            throw new Error('Unable to load dataset');
          }
          return response.json();
        })
        .then((data) => {
          datasetCache = data;
          return data;
        })
        .catch((error) => {
          datasetPromise = null;
          throw error;
        });
      return datasetPromise;
    }

    function fetchSpendPivot() {
      if (spendPivotCache) {
        return Promise.resolve(spendPivotCache);
      }
      if (spendPivotPromise) {
        return spendPivotPromise;
      }
      spendPivotPromise = fetch('lo_spend_pivot.json')
        .then((response) => {
          if (!response.ok) {
            throw new Error('Unable to load spend pivot');
          }
          return response.json();
        })
        .then((data) => {
          spendPivotCache = data;
          return data;
        })
        .catch((error) => {
          spendPivotPromise = null;
          throw error;
        });
      return spendPivotPromise;
    }

    function fetchSkuSummaryPivot() {
      if (skuSummaryPivotCache) {
        return Promise.resolve(skuSummaryPivotCache);
      }
      if (skuSummaryPivotPromise) {
        return skuSummaryPivotPromise;
      }
      skuSummaryPivotPromise = fetch('sku_summary_pivot.json')
        .then((response) => {
          if (!response.ok) {
            throw new Error('Unable to load SKU pivot');
          }
          return response.json();
        })
        .then((data) => {
          skuSummaryPivotCache = data;
          return data;
        })
        .catch((error) => {
          skuSummaryPivotPromise = null;
          throw error;
        });
      return skuSummaryPivotPromise;
    }

    function getStickyOffsetValue() {
      const rawValue = getComputedStyle(document.documentElement).getPropertyValue('--sticky-header-offset');
      const parsed = Number.parseFloat(rawValue);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function calculateScrollBodyHeight(rowCount, viewportTopOffset, reservedSpace) {
      const baselineMinHeight = HEADER_HEIGHT + MIN_VISIBLE_ROWS * ROW_HEIGHT;
      const viewportHeight = Number.isFinite(window.innerHeight) ? window.innerHeight : baselineMinHeight;
      let availableViewport = viewportHeight;
      const bottomSpacing = Number.isFinite(reservedSpace)
        ? reservedSpace
        : TABLE_BOTTOM_MARGIN;
      if (Number.isFinite(viewportTopOffset)) {
        availableViewport = viewportHeight - viewportTopOffset - bottomSpacing;
      } else {
        const stickyOffset = getStickyOffsetValue() + 64;
        availableViewport = viewportHeight - stickyOffset - bottomSpacing;
      }

      const usableViewport = Math.max(availableViewport, baselineMinHeight);
      const rowsToFillViewport = Math.max(
        MIN_VISIBLE_ROWS,
        Math.ceil(Math.max(0, usableViewport - HEADER_HEIGHT) / ROW_HEIGHT)
      );
      const effectiveRowCount = Math.max(rowCount, rowsToFillViewport);
      const desiredHeight = HEADER_HEIGHT + effectiveRowCount * ROW_HEIGHT;
      const heightWithinViewport = Math.min(desiredHeight, usableViewport);
      const minimumAllowedHeight = Math.min(baselineMinHeight, viewportHeight - bottomSpacing);
      const finalHeight = Math.max(heightWithinViewport, minimumAllowedHeight, HEADER_HEIGHT + MIN_VISIBLE_ROWS * ROW_HEIGHT);
      return Math.round(finalHeight);
    }

    function resizeLoTableContainers() {
      const containers = document.querySelectorAll('.lo-table-container');
      if (!containers.length) {
        return;
      }

      const viewportHeight = Number.isFinite(window.innerHeight) ? window.innerHeight : null;
      containers.forEach((container) => {
        if (!(container instanceof HTMLElement)) {
          return;
        }
        const rect = container.getBoundingClientRect();
        if (!rect) {
          return;
        }

        const topOffset = Number.isFinite(rect.top) ? rect.top : null;
        let availableHeight = viewportHeight;
        if (Number.isFinite(viewportHeight) && Number.isFinite(topOffset)) {
          availableHeight = viewportHeight - topOffset - LO_TABLE_BOTTOM_MARGIN;
        }

        if (!Number.isFinite(availableHeight)) {
          availableHeight = MIN_LO_TABLE_HEIGHT;
        }

        const finalHeight = Math.max(Math.floor(availableHeight), MIN_LO_TABLE_HEIGHT);
        container.style.height = `${finalHeight}px`;
        container.style.maxHeight = `${finalHeight}px`;
      });
    }

    function syncHeaderColumnWidths(table) {
      if (!table) {
        return;
      }
      const container = table.table().container();
      const scrollHead = container.querySelector('.dataTables_scrollHead');
      const scrollBody = container.querySelector('.dataTables_scrollBody');
      const scrollFoot = container.querySelector('.dataTables_scrollFoot');
      const headerTable = scrollHead ? scrollHead.querySelector('table') : null;
      const bodyTable = scrollBody ? scrollBody.querySelector('table') : null;
      const footTables = [];
      if (scrollFoot) {
        const scrollFootTable = scrollFoot.querySelector('table');
        if (scrollFootTable) {
          footTables.push(scrollFootTable);
        }
      }
      const baseFoot = table.table().footer();
      if (baseFoot) {
        footTables.push(baseFoot);
      }
      if (!headerTable || !bodyTable) {
        return;
      }

      const columnIndexes = table.columns().indexes().toArray();
      columnIndexes.forEach((columnIndex) => {
        const column = table.column(columnIndex);
        const headerCell = column.header();
        if (!headerCell) {
          return;
        }

        const bodyCells = column.nodes().toArray();
        let maxWidth = 0;
        bodyCells.forEach((cell) => {
          if (!(cell instanceof HTMLElement)) {
            return;
          }
          const { width } = cell.getBoundingClientRect();
          if (width > maxWidth) {
            maxWidth = width;
          }
        });

        if (maxWidth <= 0) {
          const { width } = headerCell.getBoundingClientRect();
          maxWidth = width;
        }

        if (maxWidth > 0) {
          const widthPx = `${Math.ceil(maxWidth)}px`;
          headerCell.style.width = widthPx;
          headerCell.style.minWidth = widthPx;
          headerCell.style.maxWidth = widthPx;
          headerCell.style.boxSizing = 'border-box';
          bodyCells.forEach((cell) => {
            if (cell instanceof HTMLElement) {
              cell.style.width = widthPx;
              cell.style.minWidth = widthPx;
              cell.style.maxWidth = widthPx;
              cell.style.boxSizing = 'border-box';
            }
          });
          footTables.forEach((footTable) => {
            const footCells = footTable.querySelectorAll('th');
            const footCell = footCells[columnIndex];
            if (footCell instanceof HTMLElement) {
              footCell.style.width = widthPx;
              footCell.style.minWidth = widthPx;
              footCell.style.maxWidth = widthPx;
              footCell.style.boxSizing = 'border-box';
            }
          });
        }
      });

      const bodyWidth = bodyTable.getBoundingClientRect().width;
      if (bodyWidth > 0) {
        const widthPx = `${Math.ceil(bodyWidth)}px`;
        headerTable.style.width = widthPx;
        const scrollHeadInner = scrollHead.querySelector('.dataTables_scrollHeadInner');
        if (scrollHeadInner) {
          scrollHeadInner.style.width = widthPx;
        }
        if (scrollFoot) {
          const scrollFootInner = scrollFoot.querySelector('.dataTables_scrollFootInner');
          if (scrollFootInner) {
            scrollFootInner.style.width = widthPx;
          }
        }
        footTables.forEach((footTable) => {
          footTable.style.width = widthPx;
        });
      }
    }

    function adjustScrollBodyPadding(table) {
      if (!table) {
        return;
      }
      const container = table.table().container();
      const scrollBody = container.querySelector('.dataTables_scrollBody');
      if (!scrollBody) {
        return;
      }
      const scrollFoot = container.querySelector('.dataTables_scrollFoot');
      let paddingBottom = 0;
      if (scrollFoot) {
        const footRect = scrollFoot.getBoundingClientRect();
        if (footRect && Number.isFinite(footRect.height)) {
          paddingBottom = Math.max(0, Math.ceil(footRect.height) - 6);
        }
      }
      const MINIMUM_PADDING = 16;
      const appliedPadding = Math.max(paddingBottom, MINIMUM_PADDING);
      scrollBody.style.paddingBottom = `${appliedPadding}px`;
    }

    function calculateRegularTableReservedSpace(container) {
      let reservedSpace = DEFAULT_REGULAR_TABLE_RESERVED_SPACE;
      if (!container) {
        return reservedSpace;
      }
      const footer = container.querySelector('.regular-table__footer');
      if (!footer) {
        return reservedSpace;
      }
      const footerRect = footer.getBoundingClientRect();
      if (!footerRect || !Number.isFinite(footerRect.height)) {
        return reservedSpace;
      }
      const measuredFooterSpace = Math.ceil(footerRect.height) + REGULAR_TABLE_FOOTER_EXTRA_GAP;
      reservedSpace = Math.max(reservedSpace, TABLE_BOTTOM_MARGIN + measuredFooterSpace);
      return reservedSpace;
    }

    function applyTableHeight(table) {
      if (!table) {
        return;
      }
      const rowCount = table.rows({ page: 'current' }).count();
      const container = table.table().container();
      const scrollBody = container.querySelector('.dataTables_scrollBody');
      const scrollBodyRect = scrollBody ? scrollBody.getBoundingClientRect() : null;
      const viewportTopOffset = scrollBodyRect && Number.isFinite(scrollBodyRect.top) ? scrollBodyRect.top : null;
      const reservedSpace = calculateRegularTableReservedSpace(container);
      const height = calculateScrollBodyHeight(rowCount, viewportTopOffset, reservedSpace);
      if (scrollBody) {
        scrollBody.style.height = `${height}px`;
        scrollBody.style.maxHeight = `${height}px`;
      }
      const settings = table.settings()[0];
      if (settings && settings.oScroll) {
        settings.oScroll.sY = `${height}px`;
      }
      table.columns.adjust();
      requestAnimationFrame(() => {
        syncHeaderColumnWidths(table);
        adjustScrollBodyPadding(table);
      });
    }

    function applyFooterValuesToCells(cells, values, numericColumnSet) {
      if (!cells || !values || values.length === 0) {
        return;
      }
      values.forEach((value, index) => {
        const cell = cells[index];
        if (!cell) {
          return;
        }
        const displayValue = value ?? '';
        const isLabelCell = index === 0;
        const isNumeric = numericColumnSet.has(index);
        const isTotalColumn = totalColumnIndex >= 0 && index === totalColumnIndex;
        cell.textContent = displayValue;
        cell.classList.toggle('cell-total-label', isLabelCell);
        cell.classList.toggle('cell-total', !isLabelCell);
        cell.classList.toggle('cell-numeric', isNumeric && !isLabelCell);
        cell.classList.toggle('cell-total-column', isTotalColumn);
        if (isLabelCell) {
          cell.style.textAlign = 'left';
        } else if (isNumeric) {
          cell.style.textAlign = 'right';
        } else {
          cell.style.textAlign = 'left';
        }
      });
    }

    function ensureTableFooter(tableElement, columnCount, values = [], numericColumnSet = new Set()) {
      if (!tableElement) {
        return;
      }
      const existingFoot = tableElement.querySelector('tfoot');
      if (existingFoot) {
        tableElement.removeChild(existingFoot);
      }
      const tfoot = document.createElement('tfoot');
      const row = document.createElement('tr');
      for (let index = 0; index < columnCount; index += 1) {
        row.appendChild(document.createElement('th'));
      }
      tfoot.appendChild(row);
      tableElement.appendChild(tfoot);
      if (values.length === columnCount) {
        const cells = tfoot.querySelectorAll('th');
        applyFooterValuesToCells(cells, values, numericColumnSet);
      }
    }

    function renderFooterRow(table) {
      if (!table || !regularTableFooterValues.length) {
        return;
      }
      const container = table.table().container();
      const baseFooter = table.table().footer();
      const footerTables = [];
      if (baseFooter) {
        footerTables.push(baseFooter);
      }
      const scrollFoot = container.querySelector('.dataTables_scrollFoot table');
      if (scrollFoot) {
        footerTables.push(scrollFoot);
      }
      footerTables.forEach((footerTable) => {
        const cells = footerTable.querySelectorAll('th');
        applyFooterValuesToCells(cells, regularTableFooterValues, regularTableNumericColumnSet);
      });
      adjustScrollBodyPadding(table);
    }

    function refreshRegularTableLayout() {
      if (!regularTableInitialised || !regularTable) {
        return;
      }
      applyTableHeight(regularTable);
      if (SHOW_REGULAR_TOTAL_ROW) {
        updateRegularTableFooter(regularTable);
      } else if (regularTableFooterValues.length) {
        renderFooterRow(regularTable);
      }
      moveRegularTablePagination();
    }

    function moveRegularTablePagination() {
      const paginationHost = document.getElementById('regular-table-pagination');
      const tableWrapper = document.getElementById('regular-table_wrapper');
      if (!paginationHost || !tableWrapper) {
        return;
      }
      let paginate = tableWrapper.querySelector('.dataTables_paginate');
      if (!paginate) {
        paginate = paginationHost.querySelector('.dataTables_paginate');
      }
      if (!paginate) {
        paginationHost.textContent = '';
        return;
      }
      if (paginate.parentElement !== paginationHost) {
        paginationHost.textContent = '';
        paginationHost.appendChild(paginate);
      }
    }

    function setActiveTab(targetTab) {
      tabButtons.forEach((button) => {
        const isActive = button.dataset.tab === targetTab;
        button.classList.toggle('active', isActive);
        button.setAttribute('aria-selected', String(isActive));
      });
      tabPanels.forEach((panel) => {
        const isActive = panel.dataset.tab === targetTab;
        panel.classList.toggle('active', isActive);
        panel.setAttribute('aria-hidden', String(!isActive));
      });
      if (targetTab === 'regular') {
        loadRegularTable();
        refreshRegularTableLayout();
      } else if (targetTab === 'sku-summary') {
        closeHeaderMenu();
        loadSkuSummaryTable();
      } else {
        closeHeaderMenu();
        if (targetTab === 'lo') {
          if (!loTablesInitialised) {
            renderLoMessage('Loading data');
          }
          fetchDataset()
            .then((dataset) => {
              initializeLoTables(dataset);
            })
            .catch((error) => {
              renderLoMessage(error.message || 'Unable to load data');
            });
          requestAnimationFrame(() => resizeLoTableContainers());
        }
      }
    }

    tabButtons.forEach((button) => {
      button.addEventListener('click', () => setActiveTab(button.dataset.tab));
    });

    function setActiveSubTab(targetSubTab) {
      if (!subTabButtons.length) {
        return;
      }
      subTabButtons.forEach((button) => {
        const isActive = button.dataset.subtab === targetSubTab;
        button.classList.toggle('active', isActive);
        button.setAttribute('aria-selected', String(isActive));
      });
      subTabPanels.forEach((panel) => {
        const isActive = panel.dataset.subtab === targetSubTab;
        panel.classList.toggle('active', isActive);
        panel.setAttribute('aria-hidden', String(!isActive));
      });
      if (loFilterButtonElement) {
        const hideFilter = targetSubTab === 'spend';
        loFilterButtonElement.classList.toggle('lo-card__filter-button--hidden', hideFilter);
        loFilterButtonElement.setAttribute('aria-hidden', String(hideFilter));
        if (hideFilter) {
          loFilterButtonElement.setAttribute('tabindex', '-1');
          if (regularFilterContainerElement && regularFilterContainerElement.classList.contains('is-visible')) {
            closeRegularFilter({ returnFocus: false });
          }
        } else {
          loFilterButtonElement.removeAttribute('tabindex');
        }
      }
      requestAnimationFrame(() => resizeLoTableContainers());
    }

    subTabButtons.forEach((button) => {
      button.addEventListener('click', () => setActiveSubTab(button.dataset.subtab));
    });

    if (subTabButtons.length > 0) {
      setActiveSubTab('sales');
    }

    function updateStickyOffset() {
      const headerEl = document.querySelector('header');
      const navEl = document.querySelector('.tab-nav');
      const headerHeight = headerEl ? headerEl.offsetHeight : 0;
      const navHeight = navEl ? navEl.offsetHeight : 0;
      const offset = headerHeight + navHeight + 24;
      document.documentElement.style.setProperty('--sticky-header-offset', `${offset}px`);
    }

    setActiveTab('lo');
    updateStickyOffset();
    window.addEventListener('resize', () => {
      updateStickyOffset();
      resizeLoTableContainers();
      if (regularTableInitialised && regularTable) {
        applyTableHeight(regularTable);
      }
    });

    function ensureHeaderMenu() {
      if (!headerMenuElement) {
        headerMenuElement = document.createElement('div');
        headerMenuElement.className = 'header-menu hidden';
        headerMenuElement.setAttribute('role', 'dialog');
        headerMenuElement.setAttribute('aria-modal', 'false');
        document.body.appendChild(headerMenuElement);

        document.addEventListener('click', (event) => {
          if (!headerMenuElement.classList.contains('hidden')) {
            const target = event.target;
            if (headerMenuElement && !headerMenuElement.contains(target) && !(target.closest('#regular-table thead'))) {
              closeHeaderMenu();
            }
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            closeHeaderMenu();
          }
        });

        window.addEventListener('resize', () => {
          if (!headerMenuElement.classList.contains('hidden') && activeHeaderCell) {
            positionHeaderMenu(activeHeaderCell);
          }
        });

        window.addEventListener('scroll', () => {
          if (!headerMenuElement.classList.contains('hidden') && activeHeaderCell) {
            positionHeaderMenu(activeHeaderCell);
          }
        }, { passive: true });
      }
    }

    function closeHeaderMenu() {
      if (headerMenuElement) {
        headerMenuElement.classList.add('hidden');
        headerMenuElement.innerHTML = '';
      }
      activeHeaderCell = null;
      activeColumnIndex = null;
    }

    function hasActiveColumnFilters() {
      return Object.values(columnFilters).some((values) => Array.isArray(values) && values.length > 0);
    }

    function updateRegularFilterButtonState() {
      const isActive = hasActiveColumnFilters();
      const targets = regularFilterButtons.length
        ? regularFilterButtons
        : (regularFilterButtonElement ? [regularFilterButtonElement] : []);
      targets.forEach((button) => {
        if (button) {
          button.setAttribute('data-active', isActive ? 'true' : 'false');
        }
      });
    }

    function syncRegularFilterSelectionFromFilters(columnIndex) {
      if (!Number.isFinite(columnIndex)) {
        return;
      }
      if (!(regularFilterSelection instanceof Set)) {
        regularFilterSelection = new Set();
      }
      regularFilterSelection.clear();
      const options = columnValueOptions[columnIndex] || [];
      const activeValues = columnFilters[columnIndex];
      if (Array.isArray(activeValues) && activeValues.length > 0) {
        activeValues.forEach((value) => regularFilterSelection.add(value));
      } else {
        options.forEach((value) => regularFilterSelection.add(value));
      }
    }

    function updateRegularFilterSelectAllState() {
      if (!regularFilterSelectAllInput) {
        return;
      }
      const checkboxes = regularFilterOptionsElement
        ? Array.from(regularFilterOptionsElement.querySelectorAll('input[type="checkbox"]'))
        : [];
      if (!checkboxes.length) {
        regularFilterSelectAllInput.checked = false;
        regularFilterSelectAllInput.indeterminate = false;
        regularFilterSelectAllInput.disabled = true;
        return;
      }
      regularFilterSelectAllInput.disabled = false;
      let selectedCount = 0;
      checkboxes.forEach((checkbox) => {
        if (regularFilterSelection.has(checkbox.value)) {
          checkbox.checked = true;
          selectedCount += 1;
        } else {
          checkbox.checked = false;
        }
      });
      if (selectedCount === 0) {
        regularFilterSelectAllInput.checked = false;
        regularFilterSelectAllInput.indeterminate = false;
      } else if (selectedCount === checkboxes.length) {
        regularFilterSelectAllInput.checked = true;
        regularFilterSelectAllInput.indeterminate = false;
      } else {
        regularFilterSelectAllInput.checked = false;
        regularFilterSelectAllInput.indeterminate = true;
      }
    }

    function renderRegularFilterOptions() {
      if (!regularFilterOptionsElement || !Number.isFinite(regularFilterActiveColumnIndex)) {
        return;
      }
      const allOptions = columnValueOptions[regularFilterActiveColumnIndex] || [];
      const normalizedQuery = regularFilterSearchTerm.trim().toLowerCase();
      const filteredOptions = normalizedQuery.length
        ? allOptions.filter((value) => optionLabel(value).toLowerCase().includes(normalizedQuery))
        : allOptions.slice();

      if (!filteredOptions.length) {
        regularFilterOptionsElement.innerHTML = '';
      } else {
        const optionsMarkup = filteredOptions
          .map((value) => {
            const label = optionLabel(value);
            const safeLabel = escapeHtml(label);
            const safeValue = escapeHtml(value);
            const checkedAttr = regularFilterSelection.has(value) ? ' checked' : '';
            return `<label class="regular-filter__option"><input type="checkbox" value="${safeValue}"${checkedAttr}>${safeLabel}</label>`;
          })
          .join('');
        regularFilterOptionsElement.innerHTML = optionsMarkup;
      }

      if (regularFilterEmptyElement) {
        regularFilterEmptyElement.hidden = filteredOptions.length !== 0;
      }
      updateRegularFilterSelectAllState();
    }

    function setRegularFilterColumn(columnIndex) {
      if (!Number.isFinite(columnIndex)) {
        return;
      }
      regularFilterActiveColumnIndex = columnIndex;
      if (regularFilterColumnSelect) {
        regularFilterColumnSelect.value = String(columnIndex);
      }
      syncRegularFilterSelectionFromFilters(columnIndex);
      regularFilterSearchTerm = '';
      if (regularFilterSearchInput) {
        regularFilterSearchInput.value = '';
      }
      renderRegularFilterOptions();
    }

    function openRegularFilter(triggerButton = null) {
      if (!regularFilterContainerElement || !regularFilterInitialised) {
        return;
      }
      const targets = regularFilterButtons.length
        ? regularFilterButtons.slice()
        : (regularFilterButtonElement ? [regularFilterButtonElement] : []);
      if (triggerButton) {
        activeRegularFilterTrigger = triggerButton;
      } else if (!activeRegularFilterTrigger && targets.length) {
        activeRegularFilterTrigger = targets[0];
      }
      if (activeRegularFilterTrigger && !targets.includes(activeRegularFilterTrigger)) {
        targets.push(activeRegularFilterTrigger);
      }
      if (!Number.isFinite(regularFilterActiveColumnIndex)) {
        const selectedOption = regularFilterColumnSelect && regularFilterColumnSelect.value !== ''
          ? Number(regularFilterColumnSelect.value)
          : null;
        if (Number.isFinite(selectedOption)) {
          setRegularFilterColumn(selectedOption);
        } else if (regularFilterEligibleColumns.length) {
          setRegularFilterColumn(regularFilterEligibleColumns[0].index);
        }
      } else {
        syncRegularFilterSelectionFromFilters(regularFilterActiveColumnIndex);
        renderRegularFilterOptions();
      }
      regularFilterContainerElement.removeAttribute('hidden');
      regularFilterContainerElement.classList.add('is-visible');
      regularFilterContainerElement.setAttribute('aria-hidden', 'false');
      targets.forEach((button) => {
        if (button) {
          const expanded = button === activeRegularFilterTrigger;
          button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        }
      });
      requestAnimationFrame(() => {
        if (regularFilterSearchInput) {
          regularFilterSearchInput.focus();
        }
      });
    }

    function closeRegularFilter(options = {}) {
      if (!regularFilterContainerElement) {
        return;
      }
      const { returnFocus = true } = options;
      const previousTrigger = activeRegularFilterTrigger;
      regularFilterContainerElement.classList.remove('is-visible');
      regularFilterContainerElement.setAttribute('aria-hidden', 'true');
      regularFilterContainerElement.setAttribute('hidden', '');
      const targets = regularFilterButtons.length
        ? regularFilterButtons
        : (regularFilterButtonElement ? [regularFilterButtonElement] : []);
      targets.forEach((button) => {
        if (button) {
          button.setAttribute('aria-expanded', 'false');
        }
      });
      activeRegularFilterTrigger = null;
      if (returnFocus && previousTrigger && typeof previousTrigger.focus === 'function') {
        previousTrigger.focus();
      }
    }

    function clearAllColumnFilters(table) {
      const hasTable = table && typeof table.column === 'function';
      const activeIndices = Object.keys(columnFilters)
        .map((key) => Number(key))
        .filter((index) => Number.isFinite(index));
      if (!activeIndices.length) {
        if (Object.keys(columnFilters).length) {
          columnFilters = {};
          handleFilterChange();
        }
        return;
      }
      if (hasTable) {
        activeIndices.forEach((columnIndex) => {
          table.column(columnIndex).search('', false, false);
          const headerCell = table.column(columnIndex).header();
          if (headerCell) {
            headerCell.classList.remove('has-filter');
          }
        });
        table.draw();
      }
      columnFilters = {};
      handleFilterChange();
    }

    function buildFilteredDataset(baseDataset, filters) {
      if (!baseDataset || !Array.isArray(baseDataset.columns) || !Array.isArray(baseDataset.rows)) {
        return baseDataset;
      }
      const filterEntries = Object.entries(filters || {})
        .map(([key, values]) => {
          const columnIndex = Number(key);
          if (!Number.isFinite(columnIndex)) {
            return null;
          }
          if (!Array.isArray(values) || values.length === 0) {
            return null;
          }
          return { columnIndex, values };
        })
        .filter(Boolean);
      if (!filterEntries.length) {
        return baseDataset;
      }
      const filteredRows = baseDataset.rows.filter((row) => {
        return filterEntries.every(({ columnIndex, values }) => {
          if (columnIndex < 0 || columnIndex >= baseDataset.columns.length) {
            return true;
          }
          const columnName = baseDataset.columns[columnIndex];
          const formattedValue = formatCellValue(row[columnIndex], columnName);
          return values.includes(formattedValue);
        });
      });
      return {
        columns: baseDataset.columns,
        rows: filteredRows,
      };
    }

    function handleFilterChange() {
      updateRegularFilterButtonState();
      if (!datasetCache || !Array.isArray(datasetCache.rows)) {
        return;
      }
      const filteredDataset = buildFilteredDataset(datasetCache, columnFilters);
      if (loTablesInitialised) {
        updateLoTablesWithDataset(filteredDataset);
      }
      if (skuSummaryInitialised) {
        updateSkuSummaryWithDataset(filteredDataset);
      }
    }

    function initializeRegularFilterControls(augmentedDataset) {
      if (regularFilterInitialised) {
        return;
      }
      regularFilterButtonElement = document.getElementById('regular-filter-button');
      regularFilterContainerElement = document.getElementById('regular-filter');
      regularFilterColumnSelect = document.getElementById('regular-filter-column');
      regularFilterSearchInput = document.getElementById('regular-filter-search');
      regularFilterOptionsElement = document.getElementById('regular-filter-options');
      regularFilterEmptyElement = document.getElementById('regular-filter-empty');
      regularFilterSelectAllInput = document.getElementById('regular-filter-select-all');
      regularFilterApplyButton = document.getElementById('regular-filter-apply');
      regularFilterResetButton = document.getElementById('regular-filter-reset');
      regularFilterCloseButton = regularFilterContainerElement
        ? regularFilterContainerElement.querySelector('.regular-filter__close')
        : null;
      const skuFilterButton = document.getElementById('sku-filter-button');
      regularFilterButtons = [regularFilterButtonElement, loFilterButtonElement, skuFilterButton].filter((button) => button);

      const elementsReady = [
        regularFilterButtonElement,
        regularFilterContainerElement,
        regularFilterColumnSelect,
        regularFilterSearchInput,
        regularFilterOptionsElement,
        regularFilterEmptyElement,
        regularFilterSelectAllInput,
        regularFilterApplyButton,
        regularFilterResetButton,
        regularFilterCloseButton,
      ].every(Boolean);

      if (!elementsReady) {
        return;
      }

      const filterTargets = regularFilterButtons.length
        ? regularFilterButtons
        : [regularFilterButtonElement];

      const registerFilterButton = (button) => {
        if (!button) {
          return;
        }
        button.addEventListener('click', () => {
          const isVisible = regularFilterContainerElement.classList.contains('is-visible');
          if (isVisible && activeRegularFilterTrigger === button) {
            closeRegularFilter();
          } else {
            openRegularFilter(button);
          }
        });
      };

      filterTargets.forEach(registerFilterButton);

      const columns = Array.isArray(augmentedDataset?.columns)
        ? augmentedDataset.columns
            .map((title, index) => ({
              title: title || `Column ${index + 1}`,
              index,
              options: columnValueOptions[index] || [],
            }))
            .filter((entry) => entry.options.length > 0 && entry.options.length <= REGULAR_FILTER_MAX_UNIQUE_VALUES)
        : [];

      if (!columns.length) {
        filterTargets.forEach((button) => {
          if (button) {
            button.setAttribute('aria-disabled', 'true');
            button.disabled = true;
          }
        });
        return;
      }

      filterTargets.forEach((button) => {
        if (button) {
          button.removeAttribute('aria-disabled');
          button.disabled = false;
        }
      });

      regularFilterEligibleColumns = columns;
      const optionsMarkup = columns
        .map((entry) => `<option value="${entry.index}">${escapeHtml(entry.title)}</option>`)
        .join('');
      regularFilterColumnSelect.innerHTML = optionsMarkup;

      regularFilterCloseButton.addEventListener('click', () => closeRegularFilter());

      regularFilterContainerElement.addEventListener('click', (event) => {
        const target = event.target;
        if (target === regularFilterContainerElement || (target instanceof HTMLElement && target.classList.contains('regular-filter__backdrop'))) {
          closeRegularFilter();
        }
      });

      regularFilterColumnSelect.addEventListener('change', (event) => {
        const selectedValue = Number(event.target.value);
        if (Number.isFinite(selectedValue)) {
          setRegularFilterColumn(selectedValue);
        }
      });

      regularFilterSearchInput.addEventListener('input', (event) => {
        regularFilterSearchTerm = event.target.value || '';
        renderRegularFilterOptions();
      });

      regularFilterOptionsElement.addEventListener('change', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement) || target.type !== 'checkbox') {
          return;
        }
        const value = target.value;
        if (target.checked) {
          regularFilterSelection.add(value);
        } else {
          regularFilterSelection.delete(value);
        }
        updateRegularFilterSelectAllState();
      });

      regularFilterSelectAllInput.addEventListener('change', (event) => {
        if (!Number.isFinite(regularFilterActiveColumnIndex)) {
          return;
        }
        const selectAll = event.target.checked;
        const allOptions = columnValueOptions[regularFilterActiveColumnIndex] || [];
        if (selectAll) {
          regularFilterSelection = new Set(allOptions);
        } else {
          regularFilterSelection = new Set();
        }
        renderRegularFilterOptions();
      });

      regularFilterApplyButton.addEventListener('click', () => {
        if (!Number.isFinite(regularFilterActiveColumnIndex)) {
          return;
        }
        const tableInstance = regularTableInitialised && regularTable ? regularTable : null;
        const allOptions = columnValueOptions[regularFilterActiveColumnIndex] || [];
        const selectedValues = Array.from(regularFilterSelection);
        const valuesToApply = selectedValues.length === allOptions.length ? [] : selectedValues;
        const headerCell = tableInstance ? tableInstance.column(regularFilterActiveColumnIndex).header() : null;
        applyColumnFilter(tableInstance, regularFilterActiveColumnIndex, valuesToApply, headerCell);
        closeRegularFilter();
      });

      regularFilterResetButton.addEventListener('click', () => {
        const tableInstance = regularTableInitialised && regularTable ? regularTable : null;
        clearAllColumnFilters(tableInstance);
        if (Number.isFinite(regularFilterActiveColumnIndex)) {
          syncRegularFilterSelectionFromFilters(regularFilterActiveColumnIndex);
          renderRegularFilterOptions();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && regularFilterContainerElement.classList.contains('is-visible')) {
          closeRegularFilter();
        }
      });

      regularFilterInitialised = true;
      updateRegularFilterButtonState();

      const firstColumn = columns[0];
      if (firstColumn) {
        setRegularFilterColumn(firstColumn.index);
      }
    }

    function escapeRegex(value) {
      return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function optionLabel(value) {
      const normalized = value === null || value === undefined ? '' : String(value);
      return normalized === '' ? '(Blank)' : normalized;
    }

    function escapeHtml(value) {
      return String(value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function applyColumnFilter(table, columnIndex, values, headerCell) {
      if (!Number.isFinite(columnIndex)) {
        return;
      }
      const safeValues = Array.isArray(values) ? values.slice() : [];
      const hasTable = table && typeof table.column === 'function';
      if (safeValues.length === 0) {
        if (hasTable) {
          table.column(columnIndex).search('', false, false).draw();
        }
        delete columnFilters[columnIndex];
        if (headerCell) {
          headerCell.classList.remove('has-filter');
        } else if (hasTable) {
          const tableHeaderCell = table.column(columnIndex).header();
          if (tableHeaderCell) {
            tableHeaderCell.classList.remove('has-filter');
          }
        }
        handleFilterChange();
        return;
      }
      if (hasTable) {
        const regex = `^(${safeValues.map((value) => escapeRegex(value)).join('|')})$`;
        table.column(columnIndex).search(regex, true, false).draw();
      }
      columnFilters[columnIndex] = safeValues;
      if (headerCell) {
        headerCell.classList.add('has-filter');
      } else if (hasTable) {
        const tableHeaderCell = table.column(columnIndex).header();
        if (tableHeaderCell) {
          tableHeaderCell.classList.add('has-filter');
        }
      }
      handleFilterChange();
    }

    function positionHeaderMenu(headerCell) {
      if (!headerMenuElement) return;
      const rect = headerCell.getBoundingClientRect();
      const top = rect.bottom + window.scrollY + 8;
      const left = rect.left + window.scrollX;
      headerMenuElement.style.top = `${top}px`;
      headerMenuElement.style.left = `${left}px`;
    }

    function openHeaderMenu(headerCell, table) {
      ensureHeaderMenu();
      if (!headerMenuElement) return;

      activeHeaderCell = headerCell;
      const dataTableIndexAttr = headerCell.getAttribute('data-dt-column');
      if (dataTableIndexAttr !== null && dataTableIndexAttr !== '') {
        activeColumnIndex = Number(dataTableIndexAttr);
      } else if (headerCell.dataset.columnIndex) {
        activeColumnIndex = Number(headerCell.dataset.columnIndex);
      } else {
        activeColumnIndex = headerCell.cellIndex ?? 0;
      }
      const columnTitle = headerCell.textContent.trim();
      const options = columnValueOptions[activeColumnIndex] || [];
      const selectedValues = columnFilters[activeColumnIndex] ? [...columnFilters[activeColumnIndex]] : [];

      const optionsMarkup = options.map((value) => {
        const checked = selectedValues.includes(value) ? 'checked' : '';
        const rawLabel = optionLabel(value);
        const safeLabel = escapeHtml(rawLabel);
        const safeValueAttr = escapeHtml(value);
        const dataLabel = escapeHtml(rawLabel.toLowerCase());
        return `<label class="header-menu__option" data-label="${dataLabel}"><input type="checkbox" value="${safeValueAttr}" ${checked}>${safeLabel}</label>`;
      }).join('');
      const hasOptions = options.length > 0;

      headerMenuElement.innerHTML = `
        <div class="header-menu__header">
          <h3 class="header-menu__title">${columnTitle}</h3>
          <button type="button" class="header-menu__close" aria-label="Close menu">&times;</button>
        </div>
        <div class="header-menu__section">
          <div class="header-menu__buttons">
            <button type="button" class="header-menu__button" data-sort="asc">Sort ascending</button>
            <button type="button" class="header-menu__button" data-sort="desc">Sort descending</button>
          </div>
        </div>
        <div class="header-menu__section">
          <label for="header-menu-search" class="sr-only">Search values</label>
          <input id="header-menu-search" class="header-menu__search" type="search" placeholder="Search values" autocomplete="off">
        </div>
        <div class="header-menu__section">
          <div class="header-menu__options" role="group" aria-label="Filter values">
            ${hasOptions ? optionsMarkup : ''}
          </div>
          ${hasOptions ? '<div class="header-menu__empty-message" hidden>No matches found</div>' : '<p style="margin:0.5rem 0 0;color:var(--muted);font-size:0.85rem;">No values available</p>'}
        </div>
        <div class="header-menu__footer">
          <button type="button" class="header-menu__clear">Clear</button>
          <button type="button" class="header-menu__apply">Apply</button>
        </div>
      `;

      headerMenuElement.classList.remove('hidden');
      positionHeaderMenu(headerCell);

      const closeButton = headerMenuElement.querySelector('.header-menu__close');
      closeButton?.addEventListener('click', () => closeHeaderMenu());

      const sortButtons = headerMenuElement.querySelectorAll('[data-sort]');
      sortButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          const direction = event.currentTarget.getAttribute('data-sort');
          table.order([activeColumnIndex, direction]).draw();
          closeHeaderMenu();
        });
      });

      const optionsContainer = headerMenuElement.querySelector('.header-menu__options');
      const searchInput = headerMenuElement.querySelector('#header-menu-search');
      const emptyMessage = headerMenuElement.querySelector('.header-menu__empty-message');
      if (!hasOptions && searchInput) {
        searchInput.disabled = true;
        searchInput.placeholder = 'No values available';
      }
      searchInput?.addEventListener('input', (event) => {
        const query = event.currentTarget.value.trim().toLowerCase();
        const labels = optionsContainer ? optionsContainer.querySelectorAll('.header-menu__option') : [];
        let visibleCount = 0;
        labels.forEach((labelEl) => {
          const labelValue = labelEl.getAttribute('data-label') || '';
          const isVisible = labelValue.includes(query);
          labelEl.style.display = isVisible ? 'flex' : 'none';
          if (isVisible) {
            visibleCount += 1;
          }
        });
        if (emptyMessage) {
          emptyMessage.hidden = visibleCount !== 0;
        }
      });

      const applyButton = headerMenuElement.querySelector('.header-menu__apply');
      applyButton?.addEventListener('click', () => {
        const checkedInputs = optionsContainer ? Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]')).filter((input) => input.checked) : [];
        const values = checkedInputs.map((input) => input.value);
        applyColumnFilter(table, activeColumnIndex, values, headerCell);
        closeHeaderMenu();
      });

      const clearButton = headerMenuElement.querySelector('.header-menu__clear');
      clearButton?.addEventListener('click', () => {
        if (optionsContainer) {
          optionsContainer.querySelectorAll('input[type="checkbox"]').forEach((input) => {
            input.checked = false;
          });
        }
        applyColumnFilter(table, activeColumnIndex, [], headerCell);
        closeHeaderMenu();
      });
    }

    function buildColumnOptions(dataset) {
      const sets = dataset.columns.map(() => new Set());
      dataset.rows.forEach((row) => {
        row.forEach((value, index) => {
          const columnName = dataset.columns[index];
          const formatted = formatCellValue(value, columnName);
          sets[index].add(formatted);
        });
      });
      columnValueOptions = sets.map((set) => Array.from(set).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })));
    }

    function wireHeaderEvents(table) {
      const container = table.table().container();
      const headerCells = Array.from(container.querySelectorAll('thead th'));

      headerCells.forEach((cell, index) => {
        if (!cell.dataset.columnIndex) {
          cell.dataset.columnIndex = String(index);
        }
        cell.classList.add('is-filterable');
        cell.classList.remove('is-static');
        cell.style.cursor = '';
        cell.removeAttribute('aria-disabled');
      });

      $(headerCells).off('click.DT keypress.DT');
      headerCells.forEach((cell, index) => {
        const existingHandler = headerClickHandlers.get(cell);
        if (existingHandler) {
          cell.removeEventListener('click', existingHandler);
          headerClickHandlers.delete(cell);
        }
        const isTotalColumn = totalColumnIndex >= 0 && index === totalColumnIndex;
        if (isTotalColumn) {
          return;
        }
        const handler = (event) => {
          event.preventDefault();
          event.stopPropagation();
          openHeaderMenu(cell, table);
        };
        headerClickHandlers.set(cell, handler);
        cell.addEventListener('click', handler);
      });
    }

    function isPlaceholderValue(value) {
      if (value === null || value === undefined) {
        return true;
      }
      const normalized = typeof value === 'string' ? value.trim() : value;
      return normalized === '' || normalized === '-' || normalized === '--';
    }

    function parseNumericValue(value) {
      if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (isPlaceholderValue(trimmed)) {
          return null;
        }
        const numeric = Number(trimmed.replace(/,/g, ''));
        return Number.isNaN(numeric) ? null : numeric;
      }
      return null;
    }

    function parseExcelSerialToDate(value) {
      const numeric = parseNumericValue(value);
      if (numeric === null) {
        return null;
      }
      const serial = Math.floor(numeric);
      if (serial <= 0) {
        return null;
      }
      const fractional = numeric - serial;
      const adjustedSerial = serial > 59 ? serial - 1 : serial;
      const excelEpoch = Date.UTC(1899, 11, 30);
      const dayMilliseconds = 24 * 60 * 60 * 1000;
      const timestamp = excelEpoch + adjustedSerial * dayMilliseconds + Math.round(fractional * dayMilliseconds);
      const date = new Date(timestamp);
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function formatExcelSerialDate(value) {
      const date = parseExcelSerialToDate(value);
      if (!date) {
        return null;
      }
      const day = String(date.getUTCDate()).padStart(2, '0');
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const year = date.getUTCFullYear();
      return `${day}-${month}-${year}`;
    }

    function detectNumericColumns(dataset) {
      return dataset.columns.reduce((accumulator, column, columnIndex) => {
        const normalizedColumn = column ? column.toUpperCase().trim() : '';
        if (NUMERIC_COLUMN_EXCLUSIONS.has(normalizedColumn)) {
          return accumulator;
        }
        let hasNumeric = false;
        const isNumericColumn = dataset.rows.every((row) => {
          const value = row[columnIndex];
          if (isPlaceholderValue(value)) {
            return true;
          }
          const numericValue = parseNumericValue(value);
          if (numericValue === null) {
            return false;
          }
          hasNumeric = true;
          return true;
        });
        if (isNumericColumn && hasNumeric) {
          accumulator.push(columnIndex);
        }
        return accumulator;
      }, []);
    }

    function formatCellValue(value, columnName) {
      if (isPlaceholderValue(value)) {
        return typeof value === 'string' ? value.trim() : '';
      }
      const normalizedColumn = columnName ? columnName.trim().toLowerCase() : '';
      if (normalizedColumn === 'checkout') {
        const formattedDate = formatExcelSerialDate(value);
        if (formattedDate) {
          return formattedDate;
        }
      }
      const numericValue = parseNumericValue(value);
      if (numericValue !== null) {
        const decimals = ZERO_DECIMAL_COLUMNS.has(normalizedColumn) ? 0 : 2;
        return numericValue.toFixed(decimals);
      }
      return typeof value === 'string' ? value : String(value ?? '');
    }

    function augmentDatasetWithTotals(dataset) {
      if (!dataset || !Array.isArray(dataset.columns) || !Array.isArray(dataset.rows)) {
        return {
          columns: [],
          rows: [],
          totalsRow: [],
          numericColumnIndices: [],
          totalColumnIndex: -1,
        };
      }

      const baseColumns = dataset.columns.slice();
      const numericColumnIndices = detectNumericColumns(dataset);
      const totalsByColumn = new Map();
      numericColumnIndices.forEach((index) => totalsByColumn.set(index, 0));

      const augmentedRows = dataset.rows.map((row) => {
        const newRow = row.slice();
        numericColumnIndices.forEach((columnIndex) => {
          const numericValue = parseNumericValue(row[columnIndex]);
          if (numericValue === null) {
            return;
          }
          totalsByColumn.set(columnIndex, (totalsByColumn.get(columnIndex) ?? 0) + numericValue);
        });
        return newRow;
      });

      const totalsRow = new Array(baseColumns.length).fill('');
      if (totalsRow.length > 0) {
        totalsRow[0] = TOTAL_ROW_LABEL;
      }

      numericColumnIndices.forEach((columnIndex) => {
        const total = totalsByColumn.get(columnIndex);
        if (typeof total === 'number' && Number.isFinite(total)) {
          totalsRow[columnIndex] = total;
        } else {
          totalsRow[columnIndex] = 0;
        }
      });

      return {
        columns: baseColumns,
        rows: augmentedRows,
        totalsRow,
        numericColumnIndices,
        totalColumnIndex: -1,
      };
    }

    function buildFormattedFooterValues(augmentedDataset) {
      if (!augmentedDataset || !Array.isArray(augmentedDataset.columns) || !Array.isArray(augmentedDataset.totalsRow)) {
        return [];
      }
      const numericColumns = new Set(augmentedDataset.numericColumnIndices || []);
      return augmentedDataset.totalsRow.map((value, index) => {
        if (index === 0) {
          const label = typeof value === 'string' && value.trim().length ? value : TOTAL_ROW_LABEL;
          return label;
        }
        if (numericColumns.has(index)) {
          return formatCellValue(value, augmentedDataset.columns[index]);
        }
        if (value === null || value === undefined) {
          return '';
        }
        return typeof value === 'string' ? value : String(value);
      });
    }

    function calculateRegularTableFooterValues(table) {
      if (!table || !regularTableAugmentedDataset) {
        return regularTableFooterValues;
      }

      const columns = Array.isArray(regularTableAugmentedDataset.columns)
        ? regularTableAugmentedDataset.columns
        : [];
      const columnCount = columns.length;
      if (columnCount === 0) {
        return [];
      }

      const baseValues = buildFormattedFooterValues(regularTableAugmentedDataset);
      const values = Array.isArray(baseValues) && baseValues.length === columnCount
        ? baseValues.slice()
        : (() => {
            const fallback = new Array(columnCount).fill('');
            const totalsRow = Array.isArray(regularTableAugmentedDataset.totalsRow)
              ? regularTableAugmentedDataset.totalsRow
              : [];
            const labelValue = totalsRow[0];
            if (typeof labelValue === 'string' && labelValue.trim().length) {
              fallback[0] = labelValue;
            } else {
              fallback[0] = TOTAL_ROW_LABEL;
            }
            return fallback;
          })();

      if (!regularTableNumericColumnSet || regularTableNumericColumnSet.size === 0) {
        return values;
      }

      const filteredRows = table.rows({ search: 'applied' }).data().toArray();

      regularTableNumericColumnSet.forEach((columnIndex) => {
        if (typeof columnIndex !== 'number' || columnIndex < 0 || columnIndex >= columnCount) {
          return;
        }
        let sum = 0;
        let hasValue = false;
        filteredRows.forEach((row) => {
          if (!row || columnIndex >= row.length) {
            return;
          }
          const numericValue = parseNumericValue(row[columnIndex]);
          if (numericValue !== null) {
            sum += numericValue;
            hasValue = true;
          }
        });

        const formattedTotal = hasValue
          ? formatCellValue(sum, columns[columnIndex])
          : formatCellValue(0, columns[columnIndex]);
        values[columnIndex] = formattedTotal;
      });

      return values;
    }

    function updateRegularTableFooter(table) {
      if (!SHOW_REGULAR_TOTAL_ROW || !table) {
        return;
      }
      regularTableFooterValues = calculateRegularTableFooterValues(table);
      renderFooterRow(table);
    }

    function findColumnIndex(dataset, targetName) {
      if (!dataset || !Array.isArray(dataset.columns)) {
        return -1;
      }
      const normalizedTarget = targetName ? targetName.trim().toLowerCase() : '';
      return dataset.columns.findIndex((column) => (column || '').trim().toLowerCase() === normalizedTarget);
    }

    function formatTwoDecimal(value) {
      const numeric = Number.isFinite(value) ? value : 0;
      return numberFormatter.format(numeric);
    }

    function buildLoPivot(dataset, targetColumnName, options = {}) {
      const { normalizedOrder = null, displayNameOverrides = null } = options;
      const checkoutIndex = findColumnIndex(dataset, 'checkout');
      const ownerIndex = findColumnIndex(dataset, 'listing owner');
      const valueIndex = findColumnIndex(dataset, targetColumnName);
      if (checkoutIndex < 0 || ownerIndex < 0 || valueIndex < 0) {
        return { loList: [], rows: [], order: [], displayNames: new Map() };
      }

      const normalizedDisplayOverrides = displayNameOverrides instanceof Map
        ? displayNameOverrides
        : (displayNameOverrides && typeof displayNameOverrides === 'object'
          ? new Map(Object.entries(displayNameOverrides))
          : new Map());
      const listingOwners = new Map();
      const ownerTotals = new Map();
      const dateMap = new Map();

      dataset.rows.forEach((row) => {
        const date = parseExcelSerialToDate(row[checkoutIndex]);
        if (!date) {
          return;
        }
        const isoKey = date.toISOString().slice(0, 10);
        const ownerRaw = row[ownerIndex];
        let owner = '';
        if (typeof ownerRaw === 'string') {
          owner = ownerRaw.trim();
        } else if (ownerRaw === null || ownerRaw === undefined) {
          owner = '';
        } else {
          owner = String(ownerRaw).trim();
        }
        const ownerName = owner || 'Unassigned';
        const normalizedOwner = ownerName.toLocaleLowerCase();
        const displayName = normalizedDisplayOverrides.get(normalizedOwner) ?? ownerName;

        const rawValue = row[valueIndex];
        const numericValue = parseNumericValue(rawValue);
        const value = numericValue === null ? 0 : numericValue;

        if (!listingOwners.has(normalizedOwner)) {
          listingOwners.set(normalizedOwner, displayName);
        }
        ownerTotals.set(normalizedOwner, (ownerTotals.get(normalizedOwner) ?? 0) + value);
        if (!dateMap.has(isoKey)) {
          dateMap.set(isoKey, { date, values: new Map() });
        }
        const entry = dateMap.get(isoKey);
        entry.values.set(normalizedOwner, (entry.values.get(normalizedOwner) ?? 0) + value);
      });

      let ownerOrder;
      if (Array.isArray(normalizedOrder) && normalizedOrder.length) {
        const orderSet = new Set();
        ownerOrder = normalizedOrder.filter((key) => {
          if (!listingOwners.has(key) || orderSet.has(key)) {
            return false;
          }
          orderSet.add(key);
          return true;
        });
        const remainingOwners = Array.from(listingOwners.keys()).filter((key) => !orderSet.has(key));
        remainingOwners.sort((a, b) => {
          const totalDiff = (ownerTotals.get(b) ?? 0) - (ownerTotals.get(a) ?? 0);
          if (Math.abs(totalDiff) > Number.EPSILON) {
            return totalDiff;
          }
          return listingOwners.get(a).localeCompare(listingOwners.get(b), undefined, { sensitivity: 'base' });
        });
        ownerOrder = ownerOrder.concat(remainingOwners);
      } else {
        ownerOrder = Array.from(listingOwners.keys()).sort((a, b) => {
          const totalDiff = (ownerTotals.get(b) ?? 0) - (ownerTotals.get(a) ?? 0);
          if (Math.abs(totalDiff) > Number.EPSILON) {
            return totalDiff;
          }
          return listingOwners.get(a).localeCompare(listingOwners.get(b), undefined, { sensitivity: 'base' });
        });
      }

      const loList = ownerOrder.map((key) => listingOwners.get(key));
      const rows = Array.from(dateMap.values())
        .sort((a, b) => a.date - b.date)
        .map(({ date, values }) => {
          const displayDate = displayDateFormatter.format(date);
          const formattedValues = ownerOrder.map((ownerKey) => formatTwoDecimal(values.get(ownerKey) ?? 0));
          return { displayDate, formattedValues };
        });

      const totals = ownerOrder.map((ownerKey) => formatTwoDecimal(ownerTotals.get(ownerKey) ?? 0));

      return {
        loList,
        rows,
        totals,
        order: ownerOrder,
        displayNames: new Map(listingOwners),
      };
    }

    function renderLoTable(tableElement, pivotData) {
      if (!tableElement) {
        return;
      }
      const { loList, rows, totals } = pivotData;
      if (!loList.length || !rows.length) {
        const columnCount = Math.max(1, loList.length + 1);
        tableElement.innerHTML = `<tbody><tr><td class="cell-date" colspan="${columnCount}">No data available</td></tr></tbody>`;
        return;
      }

      let headerHtml = '<thead><tr><th scope="col" class="cell-date">Date</th>';
      loList.forEach((owner) => {
        headerHtml += `<th scope="col">${escapeHtml(owner)}</th>`;
      });
      headerHtml += '</tr></thead>';

      let bodyHtml = '<tbody>';
      rows.forEach(({ displayDate, formattedValues }) => {
        bodyHtml += `<tr><td class="cell-date">${escapeHtml(displayDate)}</td>`;
        formattedValues.forEach((value) => {
          bodyHtml += `<td>${value}</td>`;
        });
        bodyHtml += '</tr>';
      });
      bodyHtml += '</tbody>';

      let footerHtml = '';
      if (Array.isArray(totals) && totals.length === loList.length) {
        footerHtml = '<tfoot><tr>';
        footerHtml += '<th scope="row" class="cell-date">Total</th>';
        totals.forEach((value) => {
          footerHtml += `<td>${value}</td>`;
        });
        footerHtml += '</tr></tfoot>';
      }

      tableElement.innerHTML = `${headerHtml}${bodyHtml}${footerHtml}`;
    }

    function buildSpendScaling(actualPivot, referencePivot) {
      if (!actualPivot || !referencePivot) {
        return null;
      }
      const ownerKeys = Array.isArray(actualPivot.loList)
        ? actualPivot.loList.map((label) => normalizeOwnerKey(label))
        : [];
      if (!ownerKeys.length) {
        return null;
      }
      const scaling = {
        ownerKeys,
        byDate: new Map(),
        totals: new Map(),
      };
      const referenceRowMap = new Map();
      if (Array.isArray(referencePivot.rows)) {
        referencePivot.rows.forEach((row) => {
          referenceRowMap.set(row.displayDate, row);
        });
      }
      if (Array.isArray(actualPivot.rows)) {
        actualPivot.rows.forEach((row) => {
          const referenceRow = referenceRowMap.get(row.displayDate);
          const valueMap = new Map();
          ownerKeys.forEach((ownerKey, index) => {
            const actualValue = parseNumericValue(row.formattedValues?.[index]) ?? 0;
            const referenceValue = referenceRow
              ? parseNumericValue(referenceRow.formattedValues?.[index]) ?? 0
              : 0;
            valueMap.set(ownerKey, { actualValue, referenceValue });
          });
          scaling.byDate.set(row.displayDate, valueMap);
        });
      }
      const referenceTotals = Array.isArray(referencePivot.totals) ? referencePivot.totals : [];
      const actualTotals = Array.isArray(actualPivot.totals) ? actualPivot.totals : [];
      ownerKeys.forEach((ownerKey, index) => {
        const actualValue = parseNumericValue(actualTotals[index]) ?? 0;
        const referenceValue = parseNumericValue(referenceTotals[index]) ?? 0;
        scaling.totals.set(ownerKey, { actualValue, referenceValue });
      });
      return scaling;
    }

    function applySpendScaling(basePivot, scaling, filtersActive) {
      if (!basePivot || !scaling) {
        return basePivot;
      }
      const ownerKeys = Array.isArray(scaling.ownerKeys) ? scaling.ownerKeys : [];
      const scaledRows = Array.isArray(basePivot.rows)
        ? basePivot.rows.map((row) => {
            const dateMap = scaling.byDate.get(row.displayDate);
            const formattedValues = Array.isArray(row.formattedValues)
              ? row.formattedValues.map((value, index) => {
                  const ownerKey = ownerKeys[index];
                  const reference = dateMap ? dateMap.get(ownerKey) : null;
                  const numericValue = parseNumericValue(value) ?? 0;
                  let scaledNumeric = numericValue;
                  if (reference) {
                    if (Math.abs(reference.referenceValue) > 1e-6) {
                      const factor = reference.actualValue / reference.referenceValue;
                      scaledNumeric = numericValue * factor;
                    } else if (!filtersActive) {
                      scaledNumeric = reference.actualValue;
                    }
                  }
                  return formatTwoDecimal(scaledNumeric);
                })
              : [];
            return { displayDate: row.displayDate, formattedValues };
          })
        : [];
      const scaledTotals = Array.isArray(basePivot.totals)
        ? basePivot.totals.map((value, index) => {
            const ownerKey = ownerKeys[index];
            const reference = scaling.totals.get(ownerKey);
            const numericValue = parseNumericValue(value) ?? 0;
            let scaledNumeric = numericValue;
            if (reference) {
              if (Math.abs(reference.referenceValue) > 1e-6) {
                const factor = reference.actualValue / reference.referenceValue;
                scaledNumeric = numericValue * factor;
              } else if (!filtersActive) {
                scaledNumeric = reference.actualValue;
              }
            }
            return formatTwoDecimal(scaledNumeric);
          })
        : [];
      return {
        loList: Array.isArray(basePivot.loList) ? basePivot.loList.slice() : [],
        rows: scaledRows,
        totals: scaledTotals,
      };
    }

    function updateLoTablesWithDataset(dataset) {
      const salesTableElement = document.getElementById('lo-sales-table');
      const spendTableElement = document.getElementById('lo-spend-table');
      if (!salesTableElement || !spendTableElement) {
        return;
      }
      const filtersActive = hasActiveColumnFilters();
      const baseOptions = {};
      if (Array.isArray(loSalesOrderCache) && loSalesOrderCache.length) {
        baseOptions.normalizedOrder = loSalesOrderCache;
      }
      if (loDisplayNameOverridesCache instanceof Map && loDisplayNameOverridesCache.size) {
        baseOptions.displayNameOverrides = loDisplayNameOverridesCache;
      }
      const salesPivot = buildLoPivot(dataset, 'total revenue', baseOptions);
      if (!Array.isArray(loSalesOrderCache) || loSalesOrderCache.length === 0) {
        loSalesOrderCache = Array.isArray(salesPivot.order) ? salesPivot.order.slice() : [];
      }
      if (salesPivot.displayNames instanceof Map) {
        loDisplayNameOverridesCache = new Map(salesPivot.displayNames);
      }
      renderLoTable(salesTableElement, salesPivot);

      let spendPivot;
      if (!filtersActive && loBaselineSpendPivot) {
        spendPivot = loBaselineSpendPivot;
      } else {
        const spendOptions = {};
        if (Array.isArray(loSalesOrderCache) && loSalesOrderCache.length) {
          spendOptions.normalizedOrder = loSalesOrderCache;
        }
        if (loDisplayNameOverridesCache instanceof Map && loDisplayNameOverridesCache.size) {
          spendOptions.displayNameOverrides = loDisplayNameOverridesCache;
        }
        const adSpendPivot = buildLoPivot(dataset, 'Ad Spend', spendOptions);
        if (!loBaselineAdSpendPivot) {
          loBaselineAdSpendPivot = adSpendPivot;
        }
        if (loSpendScalingData) {
          spendPivot = applySpendScaling(adSpendPivot, loSpendScalingData, filtersActive);
        } else {
          spendPivot = adSpendPivot;
        }
      }
      renderLoTable(spendTableElement, spendPivot);
      requestAnimationFrame(() => resizeLoTableContainers());
    }

    function normalizeOwnerKey(label) {
      if (typeof label !== 'string') {
        return '';
      }
      return label.trim().toLocaleLowerCase();
    }

    function alignPivotToReference(pivotData, referencePivot) {
      if (!pivotData || !Array.isArray(pivotData.loList) || !Array.isArray(pivotData.rows)) {
        return { loList: [], rows: [], totals: [] };
      }
      const referenceLabels = Array.isArray(referencePivot?.loList) ? referencePivot.loList : [];
      const referenceKeys = referenceLabels.map((label) => normalizeOwnerKey(label));
      const pivotKeys = pivotData.loList.map((label) => normalizeOwnerKey(label));

      const labelMap = new Map();
      pivotKeys.forEach((key, index) => {
        if (!labelMap.has(key)) {
          labelMap.set(key, pivotData.loList[index] ?? '');
        }
      });

      const columnIndexMap = new Map();
      pivotKeys.forEach((key, index) => {
        if (!columnIndexMap.has(key)) {
          columnIndexMap.set(key, index);
        }
      });

      const orderedKeys = [];
      referenceKeys.forEach((key) => {
        if (columnIndexMap.has(key) && !orderedKeys.includes(key)) {
          orderedKeys.push(key);
        }
      });
      pivotKeys.forEach((key) => {
        if (!orderedKeys.includes(key)) {
          orderedKeys.push(key);
        }
      });

      const loList = orderedKeys.map((key) => labelMap.get(key) ?? '');
      const totalsAccumulator = new Array(orderedKeys.length).fill(0);

      const rows = pivotData.rows.map((row) => {
        const displayDate = typeof row.displayDate === 'string' ? row.displayDate : '';
        const formattedValuesSource = Array.isArray(row.formattedValues) ? row.formattedValues : [];
        const formattedValues = orderedKeys.map((key, targetIndex) => {
          const columnIndex = columnIndexMap.get(key);
          if (typeof columnIndex !== 'number') {
            return '0.00';
          }
          const value = formattedValuesSource[columnIndex];
          const numericValue = parseNumericValue(value);
          if (numericValue !== null) {
            totalsAccumulator[targetIndex] += numericValue;
          }
          if (typeof value === 'string') {
            return value;
          }
          if (typeof value === 'number' && Number.isFinite(value)) {
            return value.toFixed(2);
          }
          return '0.00';
        });
        return { displayDate, formattedValues };
      });

      const totalsSource = Array.isArray(pivotData.totals) ? pivotData.totals : [];
      const totals = orderedKeys.map((key, targetIndex) => {
        const columnIndex = columnIndexMap.get(key);
        if (typeof columnIndex !== 'number') {
          const computedFallback = totalsAccumulator[targetIndex] ?? 0;
          return formatTwoDecimal(computedFallback);
        }
        const value = totalsSource[columnIndex];
        const numericValue = parseNumericValue(value);
        if (numericValue !== null) {
          return formatTwoDecimal(numericValue);
        }
        if (typeof value === 'string') {
          const trimmed = value.trim();
          if (trimmed.length) {
            return trimmed;
          }
        }
        const computedFallback = totalsAccumulator[targetIndex] ?? 0;
        return formatTwoDecimal(computedFallback);
      });

      return { loList, rows, totals };
    }

    function formatSkuSummaryValue(value, column) {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      const columnType = column && typeof column.type === 'string' ? column.type : 'decimal';
      const numeric = typeof value === 'number' ? value : Number(value);
      if (Number.isFinite(numeric)) {
        if (columnType === 'integer') {
          return integerFormatter.format(Math.round(numeric));
        }
        return numberFormatter.format(numeric);
      }
      return escapeHtml(String(value));
    }

    function buildSkuSummaryPivotFromDataset(dataset) {
      if (!dataset || !Array.isArray(dataset.columns) || !Array.isArray(dataset.rows)) {
        return { columns: [], rows: [], totals: null };
      }
      const skuIndex = findColumnIndex(dataset, 'SKU_2');
      const salePriceIndex = findColumnIndex(dataset, 'Sale Price + Shipping');
      const carrierFeeIndex = findColumnIndex(dataset, 'CARRIER FEE');
      const marketplaceFeeIndex = findColumnIndex(dataset, 'Ebay/ Amazon');
      const costIndex = findColumnIndex(dataset, 'P.COST');
      const netPerQtyIndex = findColumnIndex(dataset, 'NET/Q');
      const netIndex = findColumnIndex(dataset, 'NET');
      const revenueIndex = findColumnIndex(dataset, 'Total Revenue');
      const qtyIndex = findColumnIndex(dataset, 'Qty');
      const requiredIndices = [
        skuIndex,
        salePriceIndex,
        carrierFeeIndex,
        marketplaceFeeIndex,
        costIndex,
        netPerQtyIndex,
        netIndex,
        revenueIndex,
        qtyIndex,
      ];
      if (requiredIndices.some((index) => index === -1)) {
        return { columns: [], rows: [], totals: null };
      }

      const summary = new Map();
      const totalsAccumulator = {
        salePriceSum: 0,
        salePriceCount: 0,
        carrierFeeSum: 0,
        carrierFeeCount: 0,
        marketplaceFeeSum: 0,
        marketplaceFeeCount: 0,
        costSum: 0,
        costCount: 0,
        netPerQtySum: 0,
        netPerQtyCount: 0,
        netSum: 0,
        revenueSum: 0,
        qtySum: 0,
      };

      dataset.rows.forEach((row) => {
        const rawSku = row[skuIndex];
        const sku = rawSku === null || rawSku === undefined ? '' : String(rawSku).trim();
        if (!sku || sku === '-') {
          return;
        }
        if (!summary.has(sku)) {
          summary.set(sku, {
            sku,
            salePriceSum: 0,
            salePriceCount: 0,
            carrierFeeSum: 0,
            carrierFeeCount: 0,
            marketplaceFeeSum: 0,
            marketplaceFeeCount: 0,
            costSum: 0,
            costCount: 0,
            netPerQtySum: 0,
            netPerQtyCount: 0,
            netSum: 0,
            revenueSum: 0,
            qtySum: 0,
          });
        }
        const entry = summary.get(sku);

        const salePriceValue = parseNumericValue(row[salePriceIndex]);
        if (salePriceValue !== null) {
          entry.salePriceSum += salePriceValue;
          entry.salePriceCount += 1;
          totalsAccumulator.salePriceSum += salePriceValue;
          totalsAccumulator.salePriceCount += 1;
        }

        const carrierFeeValue = parseNumericValue(row[carrierFeeIndex]);
        if (carrierFeeValue !== null) {
          entry.carrierFeeSum += carrierFeeValue;
          entry.carrierFeeCount += 1;
          totalsAccumulator.carrierFeeSum += carrierFeeValue;
          totalsAccumulator.carrierFeeCount += 1;
        }

        const marketplaceFeeValue = parseNumericValue(row[marketplaceFeeIndex]);
        if (marketplaceFeeValue !== null) {
          entry.marketplaceFeeSum += marketplaceFeeValue;
          entry.marketplaceFeeCount += 1;
          totalsAccumulator.marketplaceFeeSum += marketplaceFeeValue;
          totalsAccumulator.marketplaceFeeCount += 1;
        }

        const costValue = parseNumericValue(row[costIndex]);
        if (costValue !== null) {
          entry.costSum += costValue;
          entry.costCount += 1;
          totalsAccumulator.costSum += costValue;
          totalsAccumulator.costCount += 1;
        }

        const netPerQtyValue = parseNumericValue(row[netPerQtyIndex]);
        if (netPerQtyValue !== null) {
          entry.netPerQtySum += netPerQtyValue;
          entry.netPerQtyCount += 1;
          totalsAccumulator.netPerQtySum += netPerQtyValue;
          totalsAccumulator.netPerQtyCount += 1;
        }

        const netValue = parseNumericValue(row[netIndex]);
        if (netValue !== null) {
          entry.netSum += netValue;
          totalsAccumulator.netSum += netValue;
        }

        const revenueValue = parseNumericValue(row[revenueIndex]);
        if (revenueValue !== null) {
          entry.revenueSum += revenueValue;
          totalsAccumulator.revenueSum += revenueValue;
        }

        const qtyValue = parseNumericValue(row[qtyIndex]);
        if (qtyValue !== null) {
          entry.qtySum += qtyValue;
          totalsAccumulator.qtySum += qtyValue;
        }
      });

      const rows = Array.from(summary.values())
        .map((entry) => ({
          sku: entry.sku,
          average_of_sale_price_shipping: entry.salePriceCount ? entry.salePriceSum / entry.salePriceCount : null,
          average_of_carrier_fee: entry.carrierFeeCount ? entry.carrierFeeSum / entry.carrierFeeCount : null,
          average_of_ebay_amazon: entry.marketplaceFeeCount ? entry.marketplaceFeeSum / entry.marketplaceFeeCount : null,
          average_of_p_cost: entry.costCount ? entry.costSum / entry.costCount : null,
          average_of_net_q: entry.netPerQtyCount ? entry.netPerQtySum / entry.netPerQtyCount : null,
          sum_of_net: entry.netSum,
          sum_of_total_revenue: entry.revenueSum,
          sum_of_qty: entry.qtySum,
        }))
        .sort((a, b) => a.sku.localeCompare(b.sku, undefined, { numeric: true, sensitivity: 'base' }));

      const totals = {
        sku: 'Grand Total',
        average_of_sale_price_shipping: totalsAccumulator.salePriceCount
          ? totalsAccumulator.salePriceSum / totalsAccumulator.salePriceCount
          : null,
        average_of_carrier_fee: totalsAccumulator.carrierFeeCount
          ? totalsAccumulator.carrierFeeSum / totalsAccumulator.carrierFeeCount
          : null,
        average_of_ebay_amazon: totalsAccumulator.marketplaceFeeCount
          ? totalsAccumulator.marketplaceFeeSum / totalsAccumulator.marketplaceFeeCount
          : null,
        average_of_p_cost: totalsAccumulator.costCount
          ? totalsAccumulator.costSum / totalsAccumulator.costCount
          : null,
        average_of_net_q: totalsAccumulator.netPerQtyCount
          ? totalsAccumulator.netPerQtySum / totalsAccumulator.netPerQtyCount
          : null,
        sum_of_net: totalsAccumulator.netSum,
        sum_of_total_revenue: totalsAccumulator.revenueSum,
        sum_of_qty: totalsAccumulator.qtySum,
      };

      const columns = [
        { key: 'sku', label: 'SKU', type: 'string' },
        { key: 'average_of_sale_price_shipping', label: 'Average of Sale Price + Shipping', type: 'decimal' },
        { key: 'average_of_carrier_fee', label: 'Average of CARRIER FEE', type: 'decimal' },
        { key: 'average_of_ebay_amazon', label: 'Average of Ebay/ Amazon', type: 'decimal' },
        { key: 'average_of_p_cost', label: 'Average of P.COST', type: 'decimal' },
        { key: 'average_of_net_q', label: 'Average of NET/Q', type: 'decimal' },
        { key: 'sum_of_net', label: 'Sum of NET', type: 'decimal' },
        { key: 'sum_of_total_revenue', label: 'Sum of Total Revenue', type: 'decimal' },
        { key: 'sum_of_qty', label: 'Sum of Qty', type: 'integer' },
      ];

      return { columns, rows, totals };
    }

    function updateSkuSummaryWithDataset(dataset) {
      const pivot = buildSkuSummaryPivotFromDataset(dataset);
      skuSummaryPivotCache = pivot;
      skuSummaryCurrentPage = 1;
      skuSummaryTotalRows = Array.isArray(pivot.rows) ? pivot.rows.length : 0;
      renderSkuSummaryTable(pivot, { page: 1 });
    }

    function renderSkuSummaryMessage(message, columnCount = 2) {
      const tableElement = document.getElementById('sku-summary-table');
      if (!tableElement) {
        return;
      }
      const span = Math.max(1, columnCount);
      const content = escapeHtml(message);
      tableElement.innerHTML = `<tbody><tr><td class="sku-table__message" colspan="${span}">${content}</td></tr></tbody>`;
      skuSummaryTotalRows = 0;
      skuSummaryCurrentPage = 1;
      renderSkuSummaryPagination(0, skuSummaryPageSize, 1);
    }

    function renderSkuSummaryPagination(totalRows, pageSize, currentPage) {
      const paginationElement = document.getElementById('sku-summary-pagination');
      if (!paginationElement) {
        return;
      }

      const toolbarElement = paginationElement.parentElement;
      const safePageSize = Number.isFinite(pageSize) && pageSize > 0 ? Math.floor(pageSize) : 25;

      if (!Number.isFinite(totalRows) || totalRows <= safePageSize) {
        paginationElement.textContent = '';
        paginationElement.setAttribute('aria-hidden', 'true');
        if (toolbarElement && toolbarElement.classList && toolbarElement.classList.contains('sku-card__toolbar')) {
          toolbarElement.setAttribute('data-active', 'false');
        }
        return;
      }

      const totalPages = Math.max(1, Math.ceil(totalRows / safePageSize));
      const safeCurrentPage = Math.min(Math.max(1, currentPage || 1), totalPages);
      const start = (safeCurrentPage - 1) * safePageSize + 1;
      const end = Math.min(totalRows, start + safePageSize - 1);

      const previousDisabled = safeCurrentPage <= 1 ? ' disabled' : '';
      const nextDisabled = safeCurrentPage >= totalPages ? ' disabled' : '';

      paginationElement.setAttribute('aria-hidden', 'false');
      if (toolbarElement && toolbarElement.classList && toolbarElement.classList.contains('sku-card__toolbar')) {
        toolbarElement.setAttribute('data-active', 'true');
      }
      paginationElement.innerHTML = `
        <button type="button" class="sku-card__pagination-button" data-action="previous"${previousDisabled}>Previous</button>
        <span class="sku-card__pagination-info">Showing ${start}&ndash;${end} of ${totalRows}</span>
        <button type="button" class="sku-card__pagination-button" data-action="next"${nextDisabled}>Next</button>
      `;
    }

    function renderSkuSummaryTable(pivotData, options = {}) {
      const tableElement = document.getElementById('sku-summary-table');
      if (!tableElement) {
        return;
      }
      const columns = Array.isArray(pivotData?.columns) ? pivotData.columns : [];
      const rows = Array.isArray(pivotData?.rows) ? pivotData.rows : [];
      if (!columns.length) {
        renderSkuSummaryMessage('No data available');
        return;
      }
      const pageSizeOption = Number.isFinite(options.pageSize) && options.pageSize > 0 ? Math.floor(options.pageSize) : skuSummaryPageSize;
      const safePageSize = pageSizeOption > 0 ? pageSizeOption : 25;
      const totalRows = rows.length;
      const totalPages = totalRows > 0 ? Math.ceil(totalRows / safePageSize) : 1;
      const requestedPage = Number.isFinite(options.page) ? Math.floor(options.page) : skuSummaryCurrentPage;
      const safePage = Math.min(Math.max(1, requestedPage), Math.max(1, totalPages));
      skuSummaryPageSize = safePageSize;
      skuSummaryCurrentPage = safePage;
      skuSummaryTotalRows = totalRows;
      const startIndex = (safePage - 1) * safePageSize;
      const paginatedRows = totalRows > 0 ? rows.slice(startIndex, startIndex + safePageSize) : [];

      const columnCount = columns.length;
      let headerHtml = '<thead><tr>';
      columns.forEach((column) => {
        const label = typeof column.label === 'string' ? column.label : '';
        headerHtml += `<th scope="col">${escapeHtml(label)}</th>`;
      });
      headerHtml += '</tr></thead>';

      let bodyHtml = '<tbody>';
      if (!paginatedRows.length) {
        bodyHtml += `<tr><td class="sku-table__message" colspan="${columnCount}">No data available</td></tr>`;
      } else {
        paginatedRows.forEach((row) => {
          bodyHtml += '<tr>';
          columns.forEach((column, index) => {
            const key = column.key;
            const value = row ? row[key] : null;
            if (index === 0) {
              const text = value === null || value === undefined ? '' : String(value);
              bodyHtml += `<td>${escapeHtml(text)}</td>`;
            } else {
              bodyHtml += `<td>${formatSkuSummaryValue(value, column)}</td>`;
            }
          });
          bodyHtml += '</tr>';
        });
      }
      bodyHtml += '</tbody>';

      let footerHtml = '';
      const totals = pivotData && typeof pivotData.totals === 'object' && pivotData.totals !== null
        ? pivotData.totals
        : null;
      if (totals) {
        footerHtml = '<tfoot><tr>';
        columns.forEach((column, index) => {
          const key = column.key;
          const value = totals[key];
          if (index === 0) {
            const text = value === null || value === undefined ? 'Grand Total' : String(value);
            footerHtml += `<th scope="row">${escapeHtml(text)}</th>`;
          } else {
            footerHtml += `<td>${formatSkuSummaryValue(value, column)}</td>`;
          }
        });
        footerHtml += '</tr></tfoot>';
      }

      tableElement.innerHTML = `${headerHtml}${bodyHtml}${footerHtml}`;
      renderSkuSummaryPagination(totalRows, safePageSize, safePage);
    }

    function loadSkuSummaryTable() {
      if (skuSummaryInitialised) {
        return;
      }
      renderSkuSummaryMessage('Loading data');
      fetchDataset()
        .then((dataset) => {
          if (!regularFilterInitialised) {
            const augmentedForFilters = augmentDatasetWithTotals(dataset);
            buildColumnOptions(augmentedForFilters);
            initializeRegularFilterControls(augmentedForFilters);
          }
          const effectiveDataset = buildFilteredDataset(dataset, columnFilters);
          const pivotData = buildSkuSummaryPivotFromDataset(effectiveDataset);
          skuSummaryPivotCache = pivotData;
          skuSummaryCurrentPage = 1;
          skuSummaryTotalRows = Array.isArray(pivotData?.rows) ? pivotData.rows.length : 0;
          renderSkuSummaryTable(pivotData, { page: 1 });
          skuSummaryInitialised = true;
        })
        .catch((error) => {
          const message = error && error.message ? error.message : 'Unable to load SKU summary';
          renderSkuSummaryMessage(message);
        });
    }

    function updateSkuSummaryPage(direction) {
      if (!skuSummaryPivotCache) {
        return;
      }
      const totalPages = Math.max(1, Math.ceil((skuSummaryTotalRows || 0) / (skuSummaryPageSize || 1)));
      if (direction === 'previous') {
        if (skuSummaryCurrentPage <= 1) {
          return;
        }
        const targetPage = skuSummaryCurrentPage - 1;
        renderSkuSummaryTable(skuSummaryPivotCache, { page: targetPage });
      } else if (direction === 'next') {
        if (skuSummaryCurrentPage >= totalPages) {
          return;
        }
        const targetPage = skuSummaryCurrentPage + 1;
        renderSkuSummaryTable(skuSummaryPivotCache, { page: targetPage });
      }
    }

    const skuSummaryPaginationElement = document.getElementById('sku-summary-pagination');
    if (skuSummaryPaginationElement) {
      skuSummaryPaginationElement.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (target.matches('button[data-action]')) {
          const action = target.getAttribute('data-action');
          if (action === 'previous' || action === 'next') {
            updateSkuSummaryPage(action);
          }
        }
      });
    }

    function renderLoMessage(message) {
      const escaped = escapeHtml(message);
      const markup = `<tbody><tr><td class="cell-date" colspan="1">${escaped}</td></tr></tbody>`;
      const salesTable = document.getElementById('lo-sales-table');
      const spendTable = document.getElementById('lo-spend-table');
      if (salesTable) {
        salesTable.innerHTML = markup;
      }
      if (spendTable) {
        spendTable.innerHTML = markup;
      }
      requestAnimationFrame(() => resizeLoTableContainers());
    }

    function initializeLoTables(dataset) {
      if (!regularFilterInitialised) {
        const augmentedForFilters = augmentDatasetWithTotals(dataset);
        buildColumnOptions(augmentedForFilters);
        initializeRegularFilterControls(augmentedForFilters);
      }
      if (loTablesInitialised) {
        const effectiveDataset = buildFilteredDataset(dataset, columnFilters);
        updateLoTablesWithDataset(effectiveDataset);
        return;
      }
      const salesTable = document.getElementById('lo-sales-table');
      const spendTable = document.getElementById('lo-spend-table');
      const salesPivot = buildLoPivot(dataset, 'total revenue');
      loSalesOrderCache = Array.isArray(salesPivot.order) ? salesPivot.order.slice() : [];
      loDisplayNameOverridesCache = salesPivot.displayNames instanceof Map
        ? new Map(salesPivot.displayNames)
        : new Map();
      renderLoTable(salesTable, salesPivot);
      requestAnimationFrame(() => resizeLoTableContainers());
      if (spendTable) {
        const loadingColumns = Math.max(1, (salesPivot?.loList?.length ?? 0) + 1);
        spendTable.innerHTML = `<tbody><tr><td class="cell-date" colspan="${loadingColumns}">Loading</td></tr></tbody>`;
      }
      const adSpendPivot = buildLoPivot(dataset, 'Ad Spend', {
        normalizedOrder: loSalesOrderCache,
        displayNameOverrides: loDisplayNameOverridesCache,
      });
      loBaselineAdSpendPivot = adSpendPivot;
      fetchSpendPivot()
        .then((pivotData) => {
          const alignedPivot = alignPivotToReference(pivotData, salesPivot);
          loBaselineSpendPivot = alignedPivot;
          loSpendScalingData = buildSpendScaling(alignedPivot, adSpendPivot);
          renderLoTable(spendTable, alignedPivot);
          requestAnimationFrame(() => resizeLoTableContainers());
        })
        .catch((error) => {
          if (!spendTable) {
            return;
          }
          loSpendScalingData = null;
          if (adSpendPivot && Array.isArray(adSpendPivot.rows) && adSpendPivot.rows.length) {
            loBaselineSpendPivot = adSpendPivot;
            renderLoTable(spendTable, adSpendPivot);
          } else {
            const baseColumnCount = Array.isArray(salesPivot?.loList) ? salesPivot.loList.length + 1 : 1;
            const message = escapeHtml(error.message || 'Unable to load spend pivot');
            spendTable.innerHTML = `<tbody><tr><td class="cell-date" colspan="${baseColumnCount}">${message}</td></tr></tbody>`;
          }
          requestAnimationFrame(() => resizeLoTableContainers());
        });
      loTablesInitialised = true;
    }

    function loadRegularTable() {
      if (regularTableInitialised) {
        return;
      }
      fetchDataset()
        .then((dataset) => {
          updateStickyOffset();

          const augmentedDataset = augmentDatasetWithTotals(dataset);
          regularTableAugmentedDataset = augmentedDataset;
          totalColumnIndex = augmentedDataset.totalColumnIndex;
          const columns = augmentedDataset.columns.map((title) => ({ title }));
          const formattedRows = augmentedDataset.rows.map((row) => row.map((value, index) => formatCellValue(value, augmentedDataset.columns[index])));
          const productColumnIndex = augmentedDataset.columns.indexOf('Product');
          const quantityColumnIndex = augmentedDataset.columns.findIndex((column) => column && column.trim().toLowerCase() === 'qty');
          const numericColumnIndices = augmentedDataset.numericColumnIndices;

          regularTableFooterValues = SHOW_REGULAR_TOTAL_ROW
            ? buildFormattedFooterValues(augmentedDataset)
            : [];
          regularTableNumericColumnSet = SHOW_REGULAR_TOTAL_ROW
            ? new Set(numericColumnIndices)
            : new Set();

          if (SHOW_REGULAR_TOTAL_ROW) {
            const tableElement = document.getElementById('regular-table');
            if (tableElement) {
              ensureTableFooter(
                tableElement,
                augmentedDataset.columns.length,
                regularTableFooterValues,
                regularTableNumericColumnSet
              );
            }
          }

          const columnClassMap = new Map();
          const addColumnClass = (columnIndex, className) => {
            if (columnIndex < 0) {
              return;
            }
            if (!columnClassMap.has(columnIndex)) {
              columnClassMap.set(columnIndex, new Set());
            }
            columnClassMap.get(columnIndex).add(className);
          };

          addColumnClass(productColumnIndex, 'cell-product');
          addColumnClass(quantityColumnIndex, 'cell-qty');
          numericColumnIndices.forEach((columnIndex) => addColumnClass(columnIndex, 'cell-numeric'));

          const columnDefs = Array.from(columnClassMap.entries()).map(([columnIndex, classSet]) => ({
            targets: Number(columnIndex),
            className: Array.from(classSet).join(' '),
          }));

          const initialRowCount = Math.min(augmentedDataset.rows.length, REGULAR_TABLE_PAGE_LENGTH);
          const initialReservedSpace = calculateRegularTableReservedSpace();
          const initialScrollHeight = `${calculateScrollBodyHeight(initialRowCount, undefined, initialReservedSpace)}px`;
          regularTable = $('#regular-table').DataTable({
            data: formattedRows,
            columns,
            columnDefs,
            scrollX: true,
            scrollY: initialScrollHeight,
            scrollCollapse: true,
            deferRender: true,
            autoWidth: true,
            order: [],
            paging: true,
            pageLength: REGULAR_TABLE_PAGE_LENGTH,
            lengthChange: false,
            info: false,
            dom: 't<"regular-table__footer"p>'
          });

          moveRegularTablePagination();
          buildColumnOptions(augmentedDataset);
          initializeRegularFilterControls(augmentedDataset);
          wireHeaderEvents(regularTable);
          applyTableHeight(regularTable);
          if (SHOW_REGULAR_TOTAL_ROW) {
            updateRegularTableFooter(regularTable);
          }
          regularTable.on('draw.dt', () => {
            wireHeaderEvents(regularTable);
            applyTableHeight(regularTable);
            if (SHOW_REGULAR_TOTAL_ROW) {
              updateRegularTableFooter(regularTable);
            }
            moveRegularTablePagination();
          });

          regularTableInitialised = true;
          requestAnimationFrame(() => refreshRegularTableLayout());
        })
        .catch((error) => {
          const tableElement = document.getElementById('regular-table');
          if (tableElement) {
            tableElement.outerHTML = `<p style="color: var(--muted);">${error.message}</p>`;
          }
        });
    }

  </script>
</body>
</html>
